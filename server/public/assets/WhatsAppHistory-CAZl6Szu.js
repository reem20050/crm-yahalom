import{g as y,r as f,h as E,d as q,i as M,j as e,p as H,z as c,G as D,n as z,H as B,I as N,J as R,C as $,q as _}from"./index-BITl8q-_.js";import{E as I}from"./external-link-BBARTLZd.js";import{T as K}from"./trash-2-DHaWZIae.js";import{R as F}from"./refresh-cw-CSP9gSB4.js";import{M as C}from"./message-circle-CpjEXpUI.js";import{S as A}from"./WhatsAppButton-CtDu9n5o.js";import{A as W}from"./alert-circle-Dg8nJNjH.js";/**
 * @license lucide-react v0.302.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const P=y("FileSpreadsheet",[["path",{d:"M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z",key:"1nnpy2"}],["polyline",{points:"14 2 14 8 20 8",key:"1ew0cm"}],["path",{d:"M8 13h2",key:"yr2amv"}],["path",{d:"M8 17h2",key:"2yhykz"}],["path",{d:"M14 13h2",key:"un5t4a"}],["path",{d:"M14 17h2",key:"10kma7"}]]);/**
 * @license lucide-react v0.302.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Q=y("File",[["path",{d:"M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z",key:"1nnpy2"}],["polyline",{points:"14 2 14 8 20 8",key:"1ew0cm"}]]);/**
 * @license lucide-react v0.302.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const U=y("Image",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]]);/**
 * @license lucide-react v0.302.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const se=y("PenLine",[["path",{d:"M12 20h9",key:"t2du7b"}],["path",{d:"M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z",key:"ymcmye"}]]);/**
 * @license lucide-react v0.302.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const V=y("Upload",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"17 8 12 3 7 8",key:"t8dd8p"}],["line",{x1:"12",x2:"12",y1:"3",y2:"15",key:"widbto"}]]);function G(s){return s<1024?s+" B":s<1024*1024?(s/1024).toFixed(1)+" KB":(s/(1024*1024)).toFixed(1)+" MB"}function O(s){return s!=null&&s.startsWith("image/")?e.jsx(U,{className:"w-5 h-5 text-purple-500"}):s!=null&&s.includes("spreadsheet")||s!=null&&s.includes("excel")?e.jsx(P,{className:"w-5 h-5 text-green-500"}):s!=null&&s.includes("pdf")?e.jsx(z,{className:"w-5 h-5 text-red-500"}):e.jsx(Q,{className:"w-5 h-5 text-blue-500"})}function ae({entityType:s,entityId:n}){const[i,m]=f.useState(!1),o=f.useRef(null),h=E(),{data:d,isLoading:v}=q({queryKey:["documents",s,n],queryFn:()=>D.getByEntity(s,n).then(t=>t.data)}),x=(d==null?void 0:d.documents)??[],j=M({mutationFn:t=>{const r=new FormData;return r.append("file",t),r.append("entity_type",s),r.append("entity_id",n),D.upload(r)},onSuccess:()=>{h.invalidateQueries({queryKey:["documents",s,n]}),c.success("מסמך הועלה בהצלחה")},onError:t=>{var g,a;const r=t;c.error(((a=(g=r.response)==null?void 0:g.data)==null?void 0:a.message)||"שגיאה בהעלאת מסמך")}}),w=M({mutationFn:t=>D.delete(t),onSuccess:()=>{h.invalidateQueries({queryKey:["documents",s,n]}),c.success("מסמך נמחק")},onError:()=>c.error("שגיאה במחיקת מסמך")}),u=t=>{if(!t||t.length===0)return;const r=t[0];if(r.size>10*1024*1024){c.error("הקובץ גדול מדי (מקסימום 10MB)");return}j.mutate(r)},b=t=>{t.preventDefault(),m(!1),u(t.dataTransfer.files)};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:`border-2 border-dashed rounded-lg p-6 text-center transition-colors cursor-pointer ${i?"border-primary-500 bg-primary-50":"border-gray-300 hover:border-primary-400 hover:bg-gray-50"}`,onDragOver:t=>{t.preventDefault(),m(!0)},onDragLeave:()=>m(!1),onDrop:b,onClick:()=>{var t;return(t=o.current)==null?void 0:t.click()},children:[j.isPending?e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(H,{className:"w-6 h-6 animate-spin text-primary-500"}),e.jsx("span",{className:"text-primary-600 font-medium",children:"מעלה..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(V,{className:"w-8 h-8 text-gray-400 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600",children:"גרור קובץ לכאן או לחץ לבחירה"}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"מקסימום 10MB"})]}),e.jsx("input",{ref:o,type:"file",className:"hidden",onChange:t=>u(t.target.files)})]}),v?e.jsx("div",{className:"text-center py-4",children:e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-2 border-primary-600 border-t-transparent mx-auto"})}):x.length>0?e.jsx("div",{className:"divide-y divide-gray-100",children:x.map(t=>e.jsxs("div",{className:"flex items-center justify-between py-3",children:[e.jsxs("div",{className:"flex items-center gap-3 min-w-0",children:[O(t.file_type),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",children:t.file_name}),e.jsxs("p",{className:"text-xs text-gray-500",children:[G(t.file_size)," • ",t.uploaded_by_name||"מערכת"," • ",new Date(t.created_at).toLocaleDateString("he-IL")]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-shrink-0",children:[t.google_drive_url&&e.jsx("a",{href:t.google_drive_url,target:"_blank",rel:"noopener noreferrer",className:"text-primary-600 hover:text-primary-700 p-1",title:"פתח ב-Google Drive",children:e.jsx(I,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>{confirm("האם למחוק מסמך זה?")&&w.mutate(t.id)},className:"text-red-400 hover:text-red-600 p-1",title:"מחק מסמך",children:e.jsx(K,{className:"w-4 h-4"})})]})]},t.id))}):e.jsx("p",{className:"text-center text-gray-400 text-sm py-4",children:"אין מסמכים"})]})}const S={shift_reminder:{label:"תזכורת משמרת",icon:R,color:"bg-blue-100 text-blue-700"},invoice_reminder:{label:"תזכורת חשבונית",icon:z,color:"bg-orange-100 text-orange-700"},assignment_confirmation:{label:"אישור שיבוץ",icon:N,color:"bg-green-100 text-green-700"},booking_confirmation:{label:"אישור הזמנה",icon:N,color:"bg-green-100 text-green-700"},guard_arrival:{label:"הגעת מאבטח",icon:B,color:"bg-purple-100 text-purple-700"},incoming:{label:"נכנסת",icon:C,color:"bg-gray-100 text-gray-700"},manual:{label:"ידנית",icon:A,color:"bg-gray-100 text-gray-600"}};function re({entityType:s,entityId:n,phone:i,entityName:m}){var g;const[o,h]=f.useState(""),d=f.useRef(null),v=E(),{data:x,isLoading:j,refetch:w}=q({queryKey:["whatsapp-messages",s,n],queryFn:()=>_.getWhatsAppMessages({entityType:s,entityId:n,...i?{phone:i}:{}}),refetchInterval:1e4}),u=((g=x==null?void 0:x.data)==null?void 0:g.messages)||[],b=M({mutationFn:a=>_.sendWhatsAppChat(i||"",a,s,n),onSuccess:()=>{h(""),c.success("הודעה נשלחה"),v.invalidateQueries({queryKey:["whatsapp-messages",s,n]})},onError:()=>{c.error("שגיאה בשליחת הודעה")}});f.useEffect(()=>{var a;(a=d.current)==null||a.scrollIntoView({behavior:"smooth"})},[u.length]);const t=a=>{a.preventDefault(),!(!o.trim()||!i)&&b.mutate(o.trim())},r=a=>{const l=new Date(a),p=new Date,k=l.toDateString()===p.toDateString(),L=l.toLocaleTimeString("he-IL",{hour:"2-digit",minute:"2-digit"});return k?L:`${l.toLocaleDateString("he-IL",{day:"2-digit",month:"2-digit"})} ${L}`};return j?e.jsxs("div",{className:"flex items-center justify-center py-12",children:[e.jsx(F,{className:"w-6 h-6 animate-spin text-green-600"}),e.jsx("span",{className:"mr-2 text-gray-500",children:"טוען הודעות..."})]}):e.jsxs("div",{className:"flex flex-col h-full",style:{minHeight:"400px",maxHeight:"600px"},children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 bg-[#075E54] text-white rounded-t-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(C,{className:"w-5 h-5"}),e.jsx("span",{className:"font-medium",children:m||i||"WhatsApp"})]}),e.jsx("button",{onClick:()=>w(),className:"p-1 hover:bg-white/20 rounded",children:e.jsx(F,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto px-4 py-3 space-y-2",style:{background:"#ECE5DD",minHeight:"300px"},children:[u.length===0?e.jsxs("div",{className:"text-center text-gray-500 mt-10",children:[e.jsx(C,{className:"w-12 h-12 mx-auto mb-2 opacity-30"}),e.jsx("p",{children:"אין הודעות עדיין"})]}):u.map(a=>{const l=a.direction==="outgoing",p=S[a.context]||S.manual,k=p.icon;return e.jsx("div",{className:`flex ${l?"justify-start":"justify-end"}`,children:e.jsxs("div",{className:`max-w-[80%] rounded-lg px-3 py-2 shadow-sm ${l?"bg-[#DCF8C6] rounded-tl-none":"bg-white rounded-tr-none"}`,children:[a.context&&a.context!=="manual"&&a.context!=="incoming"&&e.jsxs("div",{className:`inline-flex items-center gap-1 text-xs px-2 py-0.5 rounded-full mb-1 ${p.color}`,children:[e.jsx(k,{className:"w-3 h-3"}),p.label]}),e.jsx("p",{className:"text-sm whitespace-pre-wrap text-gray-900 leading-relaxed",children:a.message}),e.jsxs("div",{className:`flex items-center gap-1 mt-1 ${l?"justify-start":"justify-end"}`,children:[e.jsx("span",{className:"text-[10px] text-gray-500",children:r(a.created_at)}),l&&(a.status==="failed"?e.jsx(W,{className:"w-3 h-3 text-red-500"}):a.status==="read"?e.jsx(N,{className:"w-3 h-3 text-blue-500"}):a.status==="delivered"?e.jsx(N,{className:"w-3 h-3 text-gray-400"}):e.jsx($,{className:"w-3 h-3 text-gray-400"}))]})]})},a.id)}),e.jsx("div",{ref:d})]}),i?e.jsxs("form",{onSubmit:t,className:"flex items-center gap-2 px-3 py-2 bg-gray-100 rounded-b-lg border-t",children:[e.jsx("input",{type:"text",value:o,onChange:a=>h(a.target.value),placeholder:"הקלד הודעה...",className:"flex-1 px-3 py-2 rounded-full border border-gray-300 text-sm focus:outline-none focus:border-green-500",dir:"rtl"}),e.jsx("button",{type:"submit",disabled:!o.trim()||b.isPending,className:"p-2 bg-[#128C7E] text-white rounded-full hover:bg-[#075E54] disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:e.jsx(A,{className:"w-5 h-5"})})]}):e.jsx("div",{className:"text-center py-3 bg-gray-100 rounded-b-lg text-gray-500 text-sm border-t",children:"אין מספר טלפון - לא ניתן לשלוח הודעות"})]})}export{ae as D,se as P,re as W};
