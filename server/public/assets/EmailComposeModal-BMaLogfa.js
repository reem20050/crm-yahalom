import{c as T,r as N,e as D,d as L,j as e,m as S,x as P,U as A,z as p,y as w,X as $,L as k,D as F}from"./index-CYVBYVvl.js";import{P as q}from"./plus-p_an0ThM.js";import{S as I}from"./save-BK0rCRCi.js";import{M as Y}from"./mail-PtKQKhMA.js";import{R as z}from"./refresh-cw-Dxqpz4z1.js";import{M}from"./message-circle-CjovvPKe.js";import{P as Q}from"./phone-D7QUjJCD.js";import{S as R}from"./WhatsAppButton-csVOSNvP.js";const _={call:{label:"שיחה",icon:Q,colorClass:"text-blue-600",bgClass:"bg-blue-100"},meeting:{label:"פגישה",icon:A,colorClass:"text-purple-600",bgClass:"bg-purple-100"},proposal:{label:"הצעת מחיר",icon:P,colorClass:"text-orange-600",bgClass:"bg-orange-100"},note:{label:"הערה",icon:M,colorClass:"text-gray-600",bgClass:"bg-gray-100"},whatsapp:{label:"WhatsApp",icon:M,colorClass:"text-green-600",bgClass:"bg-green-100"},status_change:{label:"שינוי סטטוס",icon:z,colorClass:"text-yellow-600",bgClass:"bg-yellow-100"},email:{label:"אימייל",icon:Y,colorClass:"text-cyan-600",bgClass:"bg-cyan-100"}},K=Object.entries(_).map(([o,{label:t}])=>({value:o,label:t}));function V(o){const t=new Date(o),i=new Date,l=i.getTime()-t.getTime(),c=Math.floor(l/6e4),m=Math.floor(l/36e5),d=Math.floor(l/864e5),r=t.toLocaleTimeString("he-IL",{hour:"2-digit",minute:"2-digit"}),u=t.getDate()===i.getDate()&&t.getMonth()===i.getMonth()&&t.getFullYear()===i.getFullYear(),n=new Date(i);n.setDate(n.getDate()-1);const b=t.getDate()===n.getDate()&&t.getMonth()===n.getMonth()&&t.getFullYear()===n.getFullYear();return c<1?"עכשיו":c<60?`לפני ${c} דקות`:u?m===1?"לפני שעה":m<4?`לפני ${m} שעות`:`היום ${r}`:b?`אתמול ${r}`:d<7?`לפני ${d} ימים`:t.toLocaleDateString("he-IL",{day:"numeric",month:"short",year:t.getFullYear()!==i.getFullYear()?"numeric":void 0})+` ${r}`}function Z({entityType:o,entityId:t}){const i=T(),[l,c]=N.useState(!1),[m,d]=N.useState("call"),[r,u]=N.useState(""),n=["activities",o,t],{data:b,isLoading:j}=D({queryKey:n,queryFn:()=>(o==="lead"?w.getForLead:w.getForCustomer)(t).then(v=>v.data),enabled:!!t}),x=(b==null?void 0:b.activities)??[],f=L({mutationFn:s=>(o==="lead"?w.addToLead:w.addToCustomer)(t,s),onSuccess:()=>{i.invalidateQueries({queryKey:n}),p.success("הפעולה נוספה בהצלחה"),u(""),d("call"),c(!1)},onError:()=>{p.error("שגיאה בהוספת פעולה")}}),C=s=>{if(s.preventDefault(),!r.trim()){p.error("נא להזין תיאור");return}f.mutate({action:m,description:r.trim()})};return e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"יומן פעולות"}),e.jsx("button",{onClick:()=>c(!l),className:"btn-primary text-sm flex items-center gap-1 px-3 py-1.5",children:l?e.jsx(e.Fragment,{children:"סגור"}):e.jsxs(e.Fragment,{children:[e.jsx(q,{className:"w-4 h-4"}),"הוסף פעולה"]})})]}),l&&e.jsxs("form",{onSubmit:C,className:"mb-6 p-4 bg-blue-50 rounded-lg space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"סוג פעולה"}),e.jsx("select",{value:m,onChange:s=>d(s.target.value),className:"input",children:K.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"תיאור"}),e.jsx("textarea",{value:r,onChange:s=>u(s.target.value),className:"input",rows:3,placeholder:"תאר את הפעולה..."})]}),e.jsxs("button",{type:"submit",disabled:f.isPending||!r.trim(),className:"btn-primary text-sm flex items-center gap-1",children:[e.jsx(I,{className:"w-4 h-4"}),f.isPending?"שומר...":"שמור"]})]}),j&&e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-2 border-primary-600 border-t-transparent"})}),!j&&x.length===0&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(S,{className:"w-12 h-12 text-gray-300 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-500 font-medium",children:"אין פעולות עדיין"}),e.jsx("p",{className:"text-gray-400 text-sm mt-1",children:"הוסף פעולה ראשונה כדי להתחיל לעקוב"})]}),!j&&x.length>0&&e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute right-[19px] top-0 bottom-0 w-0.5 bg-gray-200"}),e.jsx("div",{className:"space-y-0",children:x.map((s,v)=>{const a=_[s.action]??{label:s.action,icon:S,colorClass:"text-gray-600",bgClass:"bg-gray-100"},y=a.icon;return e.jsxs("div",{className:"relative flex gap-4 pb-6",children:[e.jsx("div",{className:`relative z-10 flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center ${a.bgClass}`,children:e.jsx(y,{className:`w-5 h-5 ${a.colorClass}`})}),e.jsxs("div",{className:"flex-1 pt-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"text-sm font-semibold text-gray-900",children:a.label}),e.jsx("span",{className:"text-xs text-gray-400",children:V(s.created_at)})]}),s.description&&e.jsx("p",{className:"text-sm text-gray-700 mt-1 whitespace-pre-wrap",children:s.description}),s.user_name&&e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:s.user_name})]}),v===x.length-1&&e.jsx("div",{className:"absolute right-[19px] bottom-0 h-6 w-0.5 bg-white"})]},s.id)})})]})]})}function ee({isOpen:o,onClose:t,defaultTo:i="",defaultName:l=""}){const[c,m]=N.useState(i),[d,r]=N.useState(""),[u,n]=N.useState(""),b=T(),{data:j}=D({queryKey:["email-templates"],queryFn:()=>F.getEmailTemplates().then(a=>a.data),enabled:o}),x=(j==null?void 0:j.templates)??[],f=L({mutationFn:()=>F.sendEmail(c,d,u),onSuccess:()=>{p.success("אימייל נשלח בהצלחה"),b.invalidateQueries({queryKey:["activity-logs"]}),C()},onError:a=>{var h,g;const y=a;p.error(((g=(h=y.response)==null?void 0:h.data)==null?void 0:g.message)||"שגיאה בשליחת אימייל")}}),C=()=>{m(i),r(""),n(""),t()},s=a=>{const y=x.find(E=>E.id===a);if(!y)return;let h=y.subject,g=y.body;l&&(h=h.replace(/\{customer_name\}/g,l),g=g.replace(/\{customer_name\}/g,l),h=h.replace(/\{employee_name\}/g,l),g=g.replace(/\{employee_name\}/g,l)),r(h),n(g)},v=()=>{if(!c||!c.includes("@")){p.error("נדרשת כתובת אימייל תקינה");return}if(!d.trim()){p.error("נדרש נושא");return}if(!u.trim()){p.error("נדרש תוכן ההודעה");return}f.mutate()};return o?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900/40 backdrop-blur-sm animate-fade-in",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-modal w-full max-w-2xl max-h-[90vh] overflow-y-auto animate-slide-up",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center",children:e.jsx(Y,{className:"w-5 h-5 text-blue-600"})}),e.jsx("h2",{className:"text-xl font-bold",children:"שליחת אימייל"})]}),e.jsx("button",{onClick:C,className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx($,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"p-6 space-y-4",children:[x.length>0&&e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(P,{className:"w-4 h-4"}),"תבנית"]}),e.jsxs("select",{onChange:a=>s(a.target.value),className:"input",defaultValue:"",children:[e.jsx("option",{value:"",children:"בחר תבנית (אופציונלי)..."}),x.map(a=>e.jsx("option",{value:a.id,children:a.name},a.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"נמען *"}),e.jsx("input",{type:"email",value:c,onChange:a=>m(a.target.value),className:"input",dir:"ltr",placeholder:"email@example.com"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"נושא *"}),e.jsx("input",{type:"text",value:d,onChange:a=>r(a.target.value),className:"input",placeholder:"נושא האימייל..."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"תוכן ההודעה *"}),e.jsx("textarea",{value:u,onChange:a=>n(a.target.value),className:"input min-h-[200px]",placeholder:"כתוב את ההודעה כאן..."}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"ניתן להשתמש ב-HTML לעיצוב"})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx("button",{onClick:v,disabled:f.isPending,className:"btn-primary flex-1 flex items-center justify-center gap-2",children:f.isPending?e.jsxs(e.Fragment,{children:[e.jsx(k,{className:"w-4 h-4 animate-spin"}),"שולח..."]}):e.jsxs(e.Fragment,{children:[e.jsx(R,{className:"w-4 h-4"}),"שלח אימייל"]})}),e.jsx("button",{onClick:C,className:"btn-secondary",children:"ביטול"})]})]})]})}):null}export{Z as A,ee as E};
