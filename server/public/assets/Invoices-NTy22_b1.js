import{c as ie,r as d,g as le,i as re,d as q,h as j,j as e,B as ce,W as de,X as M,z as i,Y as v,E as B,m as oe}from"./index-DVPKYaqZ.js";import{u as ue}from"./index.esm-Dn34EEg_.js";import{t as me,o as xe,s as b,c as he}from"./types-Cl7WXRBO.js";import{R as pe}from"./refresh-cw-CG8aDW8q.js";import{P as je}from"./printer-zBn52Q75.js";import{P as V}from"./plus-BMlu7TrJ.js";import{T as H}from"./trash-2-DYOkOht6.js";import{C as ve}from"./check-BvqPFrHp.js";/**
 * @license lucide-react v0.302.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const be=ie("FileCheck",[["path",{d:"M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z",key:"1nnpy2"}],["polyline",{points:"14 2 14 8 20 8",key:"1ew0cm"}],["path",{d:"m9 15 2 2 4-4",key:"1grp1n"}]]),F={draft:{label:"טיוטה",class:"badge-gray"},sent:{label:"נשלחה",class:"badge-info"},paid:{label:"שולמה",class:"badge-success"},overdue:{label:"באיחור",class:"badge-danger"},cancelled:{label:"בוטלה",class:"badge-gray"}},ge=xe({customer_id:b().min(1,"נדרש לבחור לקוח"),invoice_number:b().optional(),issue_date:b().min(1,"נדרש תאריך הפקה"),due_date:b().min(1,"נדרש תאריך תשלום"),total_amount:he.number().min(.01,"סכום חייב להיות גדול מ-0"),description:b().optional()});function ke(){var T,z,R;const[w,W]=d.useState(""),[X,h]=d.useState(!1),[D,g]=d.useState({invoiceId:"",show:!1}),[K,Q]=d.useState(new Date().toISOString().split("T")[0]),[Y,N]=d.useState(!1),[r,u]=d.useState([{description:"",quantity:1,unitPrice:0}]),[S,L]=d.useState(""),[E,$]=d.useState(new Date(Date.now()+30*24*60*60*1e3).toISOString().split("T")[0]),[G,O]=d.useState(""),c=le(),{can:p}=re(),{data:y,isLoading:J}=q({queryKey:["invoices",{status:w}],queryFn:()=>v.getAll({status:w,limit:50}).then(s=>s.data)}),{data:n}=q({queryKey:["invoices-summary"],queryFn:()=>v.getMonthlySummary().then(s=>s.data)}),{data:m}=q({queryKey:["customers-list"],queryFn:()=>oe.getAll({limit:200}).then(s=>s.data)}),C=j({mutationFn:s=>v.create(s),onSuccess:()=>{c.invalidateQueries({queryKey:["invoices"]}),c.invalidateQueries({queryKey:["invoices-summary"]}),i.success("חשבונית נוצרה בהצלחה"),h(!1),k()},onError:()=>{i.error("שגיאה ביצירת חשבונית")}}),f=j({mutationFn:({id:s,status:t,paymentDate:l})=>v.updateStatus(s,t,l),onSuccess:()=>{c.invalidateQueries({queryKey:["invoices"]}),c.invalidateQueries({queryKey:["invoices-summary"]}),i.success("סטטוס עודכן בהצלחה"),g({invoiceId:"",show:!1})},onError:()=>{i.error("שגיאה בעדכון סטטוס")}}),U=j({mutationFn:s=>v.delete(s),onSuccess:()=>{c.invalidateQueries({queryKey:["invoices"]}),c.invalidateQueries({queryKey:["invoices-summary"]}),i.success("חשבונית נמחקה בהצלחה")},onError:()=>{i.error("שגיאה במחיקת חשבונית")}}),_=j({mutationFn:s=>B.createGreenInvoice(s),onSuccess:()=>{c.invalidateQueries({queryKey:["invoices"]}),c.invalidateQueries({queryKey:["invoices-summary"]}),i.success("חשבונית ירוקה נוצרה בהצלחה"),N(!1),u([{description:"",quantity:1,unitPrice:0}]),L(""),O("")},onError:()=>i.error("שגיאה ביצירת חשבונית ירוקה")}),I=j({mutationFn:()=>B.syncGreenInvoices(),onSuccess:s=>{c.invalidateQueries({queryKey:["invoices"]}),i.success(s.data.message||"חשבוניות סונכרנו בהצלחה")},onError:()=>i.error("שגיאה בסנכרון חשבוניות")}),{register:x,handleSubmit:Z,reset:k,formState:{errors:o}}=ue({resolver:me(ge),defaultValues:{issue_date:new Date().toISOString().split("T")[0]}}),ee=s=>{C.mutate(s)},se=(s,t)=>{if(t==="paid"){g({invoiceId:s,show:!0}),Q(new Date().toISOString().split("T")[0]);return}f.mutate({id:s,status:t})},te=()=>{f.mutate({id:D.invoiceId,status:"paid",paymentDate:K})},ae=s=>s.computed_status||s.status,ne=()=>{if(!S){i.error("נדרש לבחור לקוח");return}const s=r.filter(t=>t.description&&t.unitPrice>0);if(s.length===0){i.error("נדרשת לפחות שורה אחת");return}_.mutate({customerId:S,items:s.map(t=>({description:t.description,quantity:t.quantity,unitPrice:t.unitPrice})),dueDate:E,remarks:G})};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"חשבוניות"}),e.jsx("p",{className:"text-gray-500",children:"ניהול חשבוניות ותשלומים"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[p("invoices:create")&&e.jsxs("button",{onClick:()=>I.mutate(),disabled:I.isPending,className:"btn-secondary flex items-center gap-2",children:[e.jsx(pe,{className:`w-5 h-5 ${I.isPending?"animate-spin":""}`}),"סנכרן"]}),p("invoices:create")&&e.jsxs("button",{onClick:()=>N(!0),className:"flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors",children:[e.jsx(be,{className:"w-5 h-5"}),"חשבונית ירוקה"]}),e.jsxs("button",{onClick:()=>window.print(),className:"btn-secondary flex items-center gap-2 no-print",children:[e.jsx(je,{className:"w-5 h-5"}),"הדפס"]}),p("invoices:create")&&e.jsxs("button",{onClick:()=>h(!0),className:"btn-primary flex items-center gap-2",children:[e.jsx(V,{className:"w-5 h-5"}),"חשבונית חדשה"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6",children:[e.jsxs("div",{className:"stat-card",children:[e.jsxs("p",{className:"stat-card-value",children:["₪",((n==null?void 0:n.total_amount)||0).toLocaleString()]}),e.jsx("p",{className:"stat-card-label",children:'סה"כ החודש'})]}),e.jsxs("div",{className:"stat-card",children:[e.jsxs("p",{className:"stat-card-value text-green-600",children:["₪",((n==null?void 0:n.paid_amount)||0).toLocaleString()]}),e.jsx("p",{className:"stat-card-label",children:"שולם"})]}),e.jsxs("div",{className:"stat-card",children:[e.jsxs("p",{className:"stat-card-value text-yellow-600",children:["₪",((n==null?void 0:n.pending_amount)||0).toLocaleString()]}),e.jsx("p",{className:"stat-card-label",children:"ממתין לתשלום"})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("p",{className:"stat-card-value",children:(n==null?void 0:n.total_invoices)||0}),e.jsx("p",{className:"stat-card-label",children:"חשבוניות"})]})]}),e.jsx("div",{className:"card",children:e.jsxs("select",{value:w,onChange:s=>W(s.target.value),className:"input w-auto",children:[e.jsx("option",{value:"",children:"כל הסטטוסים"}),Object.entries(F).map(([s,{label:t}])=>e.jsx("option",{value:s,children:t},s))]})}),J?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-4 border-primary-500 border-t-transparent"})}):((T=y==null?void 0:y.invoices)==null?void 0:T.length)>0?e.jsx("div",{className:"card p-0 overflow-hidden",children:e.jsx("div",{className:"table-container",children:e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"מספר חשבונית"}),e.jsx("th",{children:"לקוח"}),e.jsx("th",{children:"תאריך הפקה"}),e.jsx("th",{children:"תאריך תשלום"}),e.jsx("th",{children:"סכום"}),e.jsx("th",{children:"סטטוס"}),e.jsx("th",{children:"פעולות"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:y.invoices.map(s=>{var l,a,A;const t=ae(s);return e.jsxs("tr",{children:[e.jsxs("td",{className:"font-medium",children:["#",s.invoice_number||s.id.slice(0,8)]}),e.jsx("td",{children:e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(ce,{className:"w-4 h-4 text-gray-400"}),s.company_name]})}),e.jsx("td",{children:s.issue_date}),e.jsx("td",{children:e.jsxs("span",{className:"flex items-center gap-1",children:[s.due_date,s.days_overdue>0&&e.jsxs("span",{className:"text-red-600 text-xs",children:["(",s.days_overdue," ימים)"]})]})}),e.jsxs("td",{className:"font-medium",children:["₪",(l=s.total_amount)==null?void 0:l.toLocaleString()]}),e.jsx("td",{children:e.jsx("span",{className:((a=F[t])==null?void 0:a.class)||"badge-gray",children:((A=F[t])==null?void 0:A.label)||s.status})}),e.jsx("td",{children:e.jsxs("div",{className:"flex items-center gap-2",children:[p("invoices:status")&&t!=="paid"&&t!=="cancelled"&&e.jsxs("select",{className:"input py-1 px-2 text-sm w-auto",value:"",onChange:P=>{P.target.value&&(se(s.id,P.target.value),P.target.value="")},children:[e.jsx("option",{value:"",children:"שנה סטטוס"}),t!=="sent"&&e.jsx("option",{value:"sent",children:"נשלחה"}),e.jsx("option",{value:"paid",children:"שולמה"}),e.jsx("option",{value:"cancelled",children:"בוטלה"})]}),p("invoices:delete")&&t==="draft"&&e.jsx("button",{onClick:()=>{confirm("האם אתה בטוח שברצונך למחוק חשבונית זו?")&&U.mutate(s.id)},className:"text-red-400 hover:text-red-600 p-1",title:"מחק חשבונית",children:e.jsx(H,{className:"w-4 h-4"})})]})})]},s.id)})})]})})}):e.jsxs("div",{className:"card text-center py-12",children:[e.jsx(de,{className:"w-16 h-16 text-gray-300 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500 mb-4",children:"לא נמצאו חשבוניות"}),e.jsx("button",{onClick:()=>h(!0),className:"btn-primary",children:"צור חשבונית ראשונה"})]}),X&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b",children:[e.jsx("h2",{className:"text-xl font-bold",children:"חשבונית חדשה"}),e.jsx("button",{onClick:()=>{h(!1),k()},className:"p-2 hover:bg-gray-100 rounded-lg",children:e.jsx(M,{className:"w-5 h-5"})})]}),e.jsxs("form",{onSubmit:Z(ee),className:"p-6 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"label",children:"לקוח *"}),e.jsxs("select",{...x("customer_id"),className:"input",children:[e.jsx("option",{value:"",children:"בחר לקוח..."}),(z=m==null?void 0:m.customers)==null?void 0:z.map(s=>e.jsx("option",{value:s.id,children:s.company_name},s.id))]}),o.customer_id&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:o.customer_id.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"מספר חשבונית"}),e.jsx("input",{...x("invoice_number"),className:"input",dir:"ltr",placeholder:"אוטומטי אם ריק"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"סכום *"}),e.jsx("input",{...x("total_amount"),type:"number",step:"0.01",min:"0",className:"input",dir:"ltr",placeholder:"0.00"}),o.total_amount&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:o.total_amount.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"תאריך הפקה *"}),e.jsx("input",{...x("issue_date"),type:"date",className:"input",dir:"ltr"}),o.issue_date&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:o.issue_date.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"תאריך לתשלום *"}),e.jsx("input",{...x("due_date"),type:"date",className:"input",dir:"ltr"}),o.due_date&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:o.due_date.message})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"label",children:"תיאור"}),e.jsx("textarea",{...x("description"),className:"input min-h-[80px]",placeholder:"פירוט שירותים..."})]})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx("button",{type:"submit",disabled:C.isPending,className:"btn-primary flex-1",children:C.isPending?"שומר...":"צור חשבונית"}),e.jsx("button",{type:"button",onClick:()=>{h(!1),k()},className:"btn-secondary",children:"ביטול"})]})]})]})}),Y&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl w-full max-w-3xl max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b",children:[e.jsx("h2",{className:"text-xl font-bold",children:"הפקת חשבונית ירוקה"}),e.jsx("button",{onClick:()=>N(!1),className:"p-2 hover:bg-gray-100 rounded-lg",children:e.jsx(M,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"לקוח *"}),e.jsxs("select",{value:S,onChange:s=>L(s.target.value),className:"input",children:[e.jsx("option",{value:"",children:"בחר לקוח..."}),(R=m==null?void 0:m.customers)==null?void 0:R.map(s=>e.jsx("option",{value:s.id,children:s.company_name},s.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"פריטים"}),e.jsx("div",{className:"space-y-2",children:r.map((s,t)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"text",placeholder:"תיאור",value:s.description,onChange:l=>{const a=[...r];a[t].description=l.target.value,u(a)},className:"input flex-1"}),e.jsx("input",{type:"number",placeholder:"כמות",min:"1",value:s.quantity,onChange:l=>{const a=[...r];a[t].quantity=Number(l.target.value)||1,u(a)},className:"input w-20",dir:"ltr"}),e.jsx("input",{type:"number",placeholder:"מחיר יחידה",min:"0",step:"0.01",value:s.unitPrice||"",onChange:l=>{const a=[...r];a[t].unitPrice=Number(l.target.value)||0,u(a)},className:"input w-28",dir:"ltr"}),e.jsxs("span",{className:"text-sm font-medium w-24 text-left",dir:"ltr",children:["₪",(s.quantity*s.unitPrice).toLocaleString()]}),r.length>1&&e.jsx("button",{onClick:()=>{u(r.filter((l,a)=>a!==t))},className:"text-red-400 hover:text-red-600 p-1",children:e.jsx(H,{className:"w-4 h-4"})})]},t))}),e.jsxs("button",{type:"button",onClick:()=>u([...r,{description:"",quantity:1,unitPrice:0}]),className:"mt-2 text-sm text-primary-600 hover:text-primary-700 flex items-center gap-1",children:[e.jsx(V,{className:"w-4 h-4"}),"הוסף שורה"]})]}),e.jsxs("div",{className:"flex justify-between items-center py-3 border-t border-b font-bold text-lg",children:[e.jsx("span",{children:'סה"כ'}),e.jsxs("span",{dir:"ltr",children:["₪",r.reduce((s,t)=>s+t.quantity*t.unitPrice,0).toLocaleString()]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"תאריך לתשלום"}),e.jsx("input",{type:"date",value:E,onChange:s=>$(s.target.value),className:"input",dir:"ltr"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"הערות"}),e.jsx("textarea",{value:G,onChange:s=>O(s.target.value),className:"input min-h-[80px]",placeholder:"הערות נוספות..."})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx("button",{onClick:ne,disabled:_.isPending,className:"btn-primary flex-1",children:_.isPending?"מפיק...":"הפק חשבונית"}),e.jsx("button",{onClick:()=>N(!1),className:"btn-secondary",children:"ביטול"})]})]})]})}),D.show&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl w-full max-w-md",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b",children:[e.jsx("h2",{className:"text-lg font-bold",children:"תאריך תשלום"}),e.jsx("button",{onClick:()=>g({invoiceId:"",show:!1}),className:"p-2 hover:bg-gray-100 rounded-lg",children:e.jsx(M,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"בחר תאריך תשלום"}),e.jsx("input",{type:"date",value:K,onChange:s=>Q(s.target.value),className:"input",dir:"ltr"})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("button",{onClick:te,disabled:f.isPending,className:"btn-primary flex-1 flex items-center justify-center gap-2",children:[e.jsx(ve,{className:"w-4 h-4"}),f.isPending?"מעדכן...":"אשר תשלום"]}),e.jsx("button",{onClick:()=>g({invoiceId:"",show:!1}),className:"btn-secondary",children:"ביטול"})]})]})]})})]})}export{ke as default};
