import{j as e,h as w,r as i,d as p,i as v,z as g,a9 as c,S as C,B as S,L as k,aa as q}from"./index-bRNF7Gia.js";import{G as M,M as _,A as $,I as A}from"./GoogleMapProvider-B4FnXEOR.js";import{R as E}from"./refresh-cw-CWxMlPnw.js";import{M as K}from"./map-pin-BzAReOoP.js";import{S as y}from"./shield-SOyEChYl.js";import{E as L}from"./external-link-DvfG2zbf.js";function P(){const m=w(),[a,l]=i.useState(null),[t,j]=i.useState(""),[n,b]=i.useState(!0),{data:d=[],isLoading:Q}=p({queryKey:["sites-with-coordinates"],queryFn:()=>c.getWithCoordinates().then(s=>s.data)}),{data:N=[]}=p({queryKey:["sites-all"],queryFn:()=>c.getAll().then(s=>s.data)}),o=v({mutationFn:()=>c.geocodeAll(),onSuccess:s=>{m.invalidateQueries({queryKey:["sites-with-coordinates"]}),m.invalidateQueries({queryKey:["sites-all"]}),g.success(`${s.data.success} אתרים עודכנו, ${s.data.failed} נכשלו`)},onError:()=>g.error("שגיאה ב-geocoding")}),x=N.length-d.length,u=d.filter(s=>{var r,h;return!t||s.name.includes(t)||s.company_name.includes(t)||((r=s.city)==null?void 0:r.includes(t))||((h=s.address)==null?void 0:h.includes(t))}),f=i.useCallback((s,r)=>{window.open(`https://www.google.com/maps/dir/?api=1&destination=${s},${r}`,"_blank")},[]);return e.jsxs("div",{className:"h-[calc(100vh-4rem)] flex",children:[n&&e.jsxs("div",{className:"w-80 bg-white border-l border-gray-200 overflow-y-auto flex-shrink-0",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200",children:[e.jsxs("h2",{className:"text-lg font-bold text-gray-900 mb-3",children:["אתרים (",d.length,")"]}),e.jsxs("div",{className:"relative",children:[e.jsx(C,{className:"absolute right-3 top-2.5 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"text",value:t,onChange:s=>j(s.target.value),placeholder:"חיפוש אתר...",className:"input pr-10 text-sm"})]}),x>0&&e.jsxs("div",{className:"mt-3 p-2 bg-amber-50 rounded-lg border border-amber-200",children:[e.jsxs("p",{className:"text-xs text-amber-700 mb-2",children:[x," אתרים בלי קואורדינטות"]}),e.jsxs("button",{onClick:()=>o.mutate(),disabled:o.isPending,className:"btn-primary text-xs px-2 py-1 flex items-center gap-1",children:[o.isPending?e.jsx(E,{className:"w-3 h-3 animate-spin"}):e.jsx(K,{className:"w-3 h-3"}),"עדכן קואורדינטות"]})]})]}),e.jsx("div",{className:"divide-y divide-gray-100",children:u.map(s=>e.jsxs("button",{onClick:()=>l(s),className:`w-full text-right p-3 hover:bg-gray-50 transition-colors ${(a==null?void 0:a.id)===s.id?"bg-primary-50 border-r-2 border-primary-500":""}`,children:[e.jsx("p",{className:"font-medium text-sm text-gray-900",children:s.name}),e.jsx("p",{className:"text-xs text-gray-500",children:s.company_name}),e.jsxs("p",{className:"text-xs text-gray-400 mt-1",children:[s.address,", ",s.city]}),s.requires_weapon===1&&e.jsxs("span",{className:"inline-flex items-center gap-1 mt-1 text-xs text-red-600",children:[e.jsx(y,{className:"w-3 h-3"})," דורש נשק"]})]},s.id))})]}),e.jsxs("div",{className:"flex-1 relative",children:[e.jsx("button",{onClick:()=>b(!n),className:"absolute top-3 right-3 z-10 bg-white shadow-lg rounded-lg px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50",children:n?"הסתר רשימה":"הצג רשימה"}),e.jsxs(_,{defaultCenter:{lat:31.5,lng:34.8},defaultZoom:8,gestureHandling:"greedy",mapId:"sites-map",className:"w-full h-full",children:[u.map(s=>e.jsx($,{position:{lat:s.latitude,lng:s.longitude},onClick:()=>l(s),title:s.name,children:e.jsx("div",{className:`flex items-center justify-center w-8 h-8 rounded-full shadow-lg border-2 border-white ${s.requires_weapon?"bg-red-500":"bg-primary-500"}`,children:e.jsx(S,{className:"w-4 h-4 text-white"})})},s.id)),a&&e.jsx(A,{position:{lat:a.latitude,lng:a.longitude},onCloseClick:()=>l(null),children:e.jsxs("div",{className:"p-2 min-w-[200px]",dir:"rtl",children:[e.jsx("h3",{className:"font-bold text-gray-900",children:a.name}),e.jsx("p",{className:"text-sm text-primary-600 mb-1",children:a.company_name}),e.jsxs("p",{className:"text-sm text-gray-600",children:[a.address,", ",a.city]}),a.requires_weapon===1&&e.jsxs("p",{className:"text-xs text-red-600 flex items-center gap-1 mt-1",children:[e.jsx(y,{className:"w-3 h-3"})," דורש נשק"]}),a.requirements&&e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:a.requirements}),e.jsxs("div",{className:"flex gap-2 mt-3",children:[e.jsxs(k,{to:`/customers/${a.customer_id}`,className:"text-xs text-primary-600 hover:underline flex items-center gap-1",children:[e.jsx(L,{className:"w-3 h-3"})," פרטי לקוח"]}),e.jsxs("button",{onClick:()=>f(a.latitude,a.longitude),className:"text-xs text-green-600 hover:underline flex items-center gap-1",children:[e.jsx(q,{className:"w-3 h-3"})," ניווט"]})]})]})})]})]})]})}function B(){return e.jsx(M,{children:e.jsx(P,{})})}export{B as default};
