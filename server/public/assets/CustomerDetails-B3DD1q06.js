import{k as G,u as H,g as J,r as x,d as Z,h as g,j as e,B as ee,X as f,A as se,n as ae,z as c,m as h}from"./index-BPBwE9NU.js";import{W as le}from"./WhatsAppButton-CFbEuf00.js";import{A as te}from"./ActivityLog-BLRQYjcH.js";import{A as ne,S as ie}from"./save-DxeQCaUF.js";import{M as re}from"./map-pin-CrcavfgI.js";import{P as ce}from"./pen-line-D-cvVisg.js";import{T as de}from"./trash-2-DgMEGaWc.js";import{P as E}from"./plus-BBAlGWpg.js";import{P as me}from"./phone-D6d1rIR4.js";import{M as xe}from"./mail-DlLeOPvh.js";import"./message-circle-DTyFQplf.js";import"./send-D3T0BUU3.js";import"./external-link-D20gRu1j.js";import"./refresh-cw-DC3eyyCr.js";const R=[{value:"regular",label:"שמירה רגילה"},{value:"event",label:"אירועים"},{value:"both",label:"שניהם"}],B=[{value:"net30",label:"שוטף + 30"},{value:"net60",label:"שוטף + 60"},{value:"net90",label:"שוטף + 90"},{value:"immediate",label:"מיידי"}],W=[{value:"active",label:"פעיל"},{value:"inactive",label:"לא פעיל"},{value:"suspended",label:"מושהה"}];function Se(){var K,O,D,I,L,$,z;const{id:i}=G(),k=H(),o=J(),[_,w]=x.useState(!1),[Y,T]=x.useState(!1),[y,M]=x.useState(!1),[N,A]=x.useState(!1),[b,Q]=x.useState(!1),[t,d]=x.useState({company_name:"",business_id:"",address:"",city:"",service_type:"",payment_terms:"",status:"active",notes:""}),[n,u]=x.useState({name:"",address:"",city:"",requirements:"",requires_weapon:!1,notes:""}),[m,p]=x.useState({name:"",role:"",phone:"",email:"",is_primary:!1}),[r,j]=x.useState({start_date:"",end_date:"",monthly_value:"",terms:""}),{data:l,isLoading:U}=Z({queryKey:["customer",i],queryFn:()=>h.getOne(i).then(s=>s.data),enabled:!!i}),a=l==null?void 0:l.customer;x.useEffect(()=>{a&&d({company_name:a.company_name||"",business_id:a.business_id||"",address:a.address||"",city:a.city||"",service_type:a.service_type||"",payment_terms:a.payment_terms||"",status:a.status||"active",notes:a.notes||""})},[a]);const C=g({mutationFn:s=>h.update(i,s),onSuccess:()=>{o.invalidateQueries({queryKey:["customer",i]}),o.invalidateQueries({queryKey:["customers"]}),c.success("הלקוח עודכן בהצלחה"),w(!1)},onError:()=>c.error("שגיאה בעדכון הלקוח")}),S=g({mutationFn:()=>h.delete(i),onSuccess:()=>{o.invalidateQueries({queryKey:["customers"]}),c.success("הלקוח נמחק בהצלחה"),k("/customers")},onError:()=>c.error("שגיאה במחיקת הלקוח")}),F=g({mutationFn:s=>h.addSite(i,s),onSuccess:()=>{o.invalidateQueries({queryKey:["customer",i]}),c.success("אתר נוסף בהצלחה"),M(!1),u({name:"",address:"",city:"",requirements:"",requires_weapon:!1,notes:""})},onError:()=>c.error("שגיאה בהוספת אתר")}),P=g({mutationFn:s=>h.addContact(i,s),onSuccess:()=>{o.invalidateQueries({queryKey:["customer",i]}),c.success("איש קשר נוסף בהצלחה"),A(!1),p({name:"",role:"",phone:"",email:"",is_primary:!1})},onError:()=>c.error("שגיאה בהוספת איש קשר")}),q=g({mutationFn:s=>h.addContract(i,s),onSuccess:()=>{o.invalidateQueries({queryKey:["customer",i]}),c.success("חוזה נוסף בהצלחה"),Q(!1),j({start_date:"",end_date:"",monthly_value:"",terms:""})},onError:()=>c.error("שגיאה בהוספת חוזה")}),V=()=>{if(!t.company_name.trim()){c.error("שם חברה הוא שדה חובה");return}C.mutate(t)},X=()=>{a&&d({company_name:a.company_name||"",business_id:a.business_id||"",address:a.address||"",city:a.city||"",service_type:a.service_type||"",payment_terms:a.payment_terms||"",status:a.status||"active",notes:a.notes||""}),w(!1)};return U?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-4 border-primary-500 border-t-transparent"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("button",{onClick:()=>k("/customers"),className:"flex items-center gap-2 text-gray-600 hover:text-gray-900",children:[e.jsx(ne,{className:"w-5 h-5"}),"חזרה ללקוחות"]}),e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:"w-16 h-16 bg-primary-100 rounded-xl flex items-center justify-center",children:e.jsx(ee,{className:"w-8 h-8 text-primary-600"})}),e.jsx("div",{children:_?e.jsx("div",{className:"space-y-2",children:e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"שם חברה *"}),e.jsx("input",{value:t.company_name,onChange:s=>d({...t,company_name:s.target.value}),className:"input text-2xl font-bold",placeholder:"שם חברה"})]})}):e.jsxs(e.Fragment,{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:a==null?void 0:a.company_name}),(a==null?void 0:a.city)&&e.jsxs("p",{className:"text-gray-500 flex items-center gap-2",children:[e.jsx(re,{className:"w-4 h-4"}),a.city]})]})})]}),e.jsx("div",{className:"flex items-center gap-2",children:_?e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:V,disabled:C.isPending,className:"btn-success text-sm flex items-center gap-1 px-3 py-2",children:[e.jsx(ie,{className:"w-4 h-4"}),C.isPending?"שומר...":"שמור"]}),e.jsxs("button",{onClick:X,className:"btn-secondary text-sm flex items-center gap-1 px-3 py-2",children:[e.jsx(f,{className:"w-4 h-4"}),"ביטול"]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>w(!0),className:"btn-primary text-sm flex items-center gap-1 px-3 py-2",children:[e.jsx(ce,{className:"w-4 h-4"}),"עריכה"]}),e.jsxs("button",{onClick:()=>T(!0),className:"btn-danger text-sm flex items-center gap-1 px-3 py-2",children:[e.jsx(de,{className:"w-4 h-4"}),"מחק לקוח"]})]})})]}),Y&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-xl p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"w-12 h-12 bg-red-100 rounded-full flex items-center justify-center",children:e.jsx(se,{className:"w-6 h-6 text-red-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-bold text-gray-900",children:"מחיקת לקוח"}),e.jsx("p",{className:"text-sm text-gray-500",children:"פעולה זו אינה ניתנת לביטול"})]})]}),e.jsxs("p",{className:"text-gray-700 mb-6",children:["האם אתה בטוח שברצונך למחוק את הלקוח"," ",e.jsx("strong",{children:a==null?void 0:a.company_name}),"? כל הנתונים הקשורים ללקוח זה יימחקו לצמיתות."]}),e.jsxs("div",{className:"flex items-center gap-3 justify-end",children:[e.jsx("button",{onClick:()=>T(!1),className:"btn-secondary px-4 py-2",children:"ביטול"}),e.jsx("button",{onClick:()=>S.mutate(),disabled:S.isPending,className:"btn-danger px-4 py-2",children:S.isPending?"מוחק...":"מחק לקוח"})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"אנשי קשר"}),e.jsxs("button",{onClick:()=>A(!N),className:"btn-primary text-sm flex items-center gap-1 px-3 py-1.5",children:[N?e.jsx(f,{className:"w-4 h-4"}):e.jsx(E,{className:"w-4 h-4"}),N?"ביטול":"הוסף"]})]}),N&&e.jsxs("form",{onSubmit:s=>{s.preventDefault(),P.mutate(m)},className:"mb-4 p-4 bg-blue-50 rounded-lg space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"שם *"}),e.jsx("input",{value:m.name,onChange:s=>p({...m,name:s.target.value}),className:"input",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"תפקיד"}),e.jsx("input",{value:m.role,onChange:s=>p({...m,role:s.target.value}),className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"טלפון"}),e.jsx("input",{value:m.phone,onChange:s=>p({...m,phone:s.target.value}),className:"input",dir:"ltr"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"אימייל"}),e.jsx("input",{value:m.email,onChange:s=>p({...m,email:s.target.value}),className:"input",dir:"ltr",type:"email"})]})]}),e.jsx("button",{type:"submit",disabled:P.isPending||!m.name,className:"btn-primary text-sm",children:P.isPending?"שומר...":"שמור איש קשר"})]}),((K=l==null?void 0:l.contacts)==null?void 0:K.length)>0?e.jsx("div",{className:"space-y-3",children:l.contacts.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:s.name}),e.jsx("p",{className:"text-sm text-gray-500",children:s.role})]}),e.jsxs("div",{className:"flex items-center gap-4 text-sm",children:[s.phone&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsxs("a",{href:`tel:${s.phone}`,className:"flex items-center gap-1 text-primary-600",children:[e.jsx(me,{className:"w-4 h-4"}),s.phone]}),e.jsx(le,{phone:s.phone,name:s.name,size:"sm"})]}),s.email&&e.jsxs("a",{href:`mailto:${s.email}`,className:"flex items-center gap-1 text-primary-600",children:[e.jsx(xe,{className:"w-4 h-4"}),s.email]})]})]},s.id))}):e.jsx("p",{className:"text-gray-500 text-center py-4",children:"אין אנשי קשר"})]}),e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"אתרים"}),e.jsxs("button",{onClick:()=>M(!y),className:"btn-primary text-sm flex items-center gap-1 px-3 py-1.5",children:[y?e.jsx(f,{className:"w-4 h-4"}):e.jsx(E,{className:"w-4 h-4"}),y?"ביטול":"הוסף אתר"]})]}),y&&e.jsxs("form",{onSubmit:s=>{s.preventDefault(),F.mutate(n)},className:"mb-4 p-4 bg-green-50 rounded-lg space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"שם אתר *"}),e.jsx("input",{value:n.name,onChange:s=>u({...n,name:s.target.value}),className:"input",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"כתובת *"}),e.jsx("input",{value:n.address,onChange:s=>u({...n,address:s.target.value}),className:"input",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"עיר"}),e.jsx("input",{value:n.city,onChange:s=>u({...n,city:s.target.value}),className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"דרישות מיוחדות"}),e.jsx("input",{value:n.requirements,onChange:s=>u({...n,requirements:s.target.value}),className:"input"})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"label",children:"הערות"}),e.jsx("textarea",{value:n.notes,onChange:s=>u({...n,notes:s.target.value}),className:"input",rows:2})]}),e.jsx("div",{className:"col-span-2",children:e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:n.requires_weapon,onChange:s=>u({...n,requires_weapon:s.target.checked}),className:"w-4 h-4 text-primary-600 rounded"}),e.jsx("span",{children:"דורש נשק"})]})})]}),e.jsx("button",{type:"submit",disabled:F.isPending||!n.name||!n.address,className:"btn-primary text-sm",children:F.isPending?"שומר...":"שמור אתר"})]}),((O=l==null?void 0:l.sites)==null?void 0:O.length)>0?e.jsx("div",{className:"space-y-3",children:l.sites.map(s=>e.jsx("div",{className:"p-3 bg-gray-50 rounded-lg",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:s.name}),e.jsx("p",{className:"text-sm text-gray-500",children:s.address})]}),s.requires_weapon&&e.jsx("span",{className:"badge badge-warning",children:"דורש נשק"})]})},s.id))}):e.jsx("p",{className:"text-gray-500 text-center py-4",children:"אין אתרים"})]}),e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"חוזים"}),e.jsxs("button",{onClick:()=>Q(!b),className:"btn-primary text-sm flex items-center gap-1 px-3 py-1.5",children:[b?e.jsx(f,{className:"w-4 h-4"}):e.jsx(E,{className:"w-4 h-4"}),b?"ביטול":"הוסף חוזה"]})]}),b&&e.jsxs("form",{onSubmit:s=>{s.preventDefault(),q.mutate({...r,monthly_value:Number(r.monthly_value)})},className:"mb-4 p-4 bg-yellow-50 rounded-lg space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"תאריך התחלה *"}),e.jsx("input",{type:"date",value:r.start_date,onChange:s=>j({...r,start_date:s.target.value}),className:"input",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"תאריך סיום"}),e.jsx("input",{type:"date",value:r.end_date,onChange:s=>j({...r,end_date:s.target.value}),className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"ערך חודשי (₪)"}),e.jsx("input",{type:"number",value:r.monthly_value,onChange:s=>j({...r,monthly_value:s.target.value}),className:"input",dir:"ltr"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"תנאים"}),e.jsx("input",{value:r.terms,onChange:s=>j({...r,terms:s.target.value}),className:"input"})]})]}),e.jsx("button",{type:"submit",disabled:q.isPending||!r.start_date,className:"btn-primary text-sm",children:q.isPending?"שומר...":"שמור חוזה"})]}),((D=l==null?void 0:l.contracts)==null?void 0:D.length)>0?e.jsx("div",{className:"space-y-3",children:l.contracts.map(s=>{var v;return e.jsx("div",{className:"p-3 bg-gray-50 rounded-lg",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ae,{className:"w-5 h-5 text-gray-400"}),e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium",children:[s.start_date," - ",s.end_date||"ללא הגבלה"]}),e.jsxs("p",{className:"text-sm text-gray-500",children:["₪",(v=s.monthly_value)==null?void 0:v.toLocaleString(),"/חודש"]})]})]}),e.jsx("span",{className:`badge ${s.status==="active"?"badge-success":"badge-gray"}`,children:s.status==="active"?"פעיל":s.status})]})},s.id)})}):e.jsx("p",{className:"text-gray-500 text-center py-4",children:"אין חוזים"})]}),i&&e.jsx(te,{entityType:"customer",entityId:i})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"card",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"פרטים"}),_?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"ח.פ"}),e.jsx("input",{value:t.business_id,onChange:s=>d({...t,business_id:s.target.value}),className:"input",dir:"ltr",placeholder:"מספר ח.פ"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"כתובת"}),e.jsx("input",{value:t.address,onChange:s=>d({...t,address:s.target.value}),className:"input",placeholder:"כתובת"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"עיר"}),e.jsx("input",{value:t.city,onChange:s=>d({...t,city:s.target.value}),className:"input",placeholder:"עיר"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"סוג שירות"}),e.jsxs("select",{value:t.service_type,onChange:s=>d({...t,service_type:s.target.value}),className:"input",children:[e.jsx("option",{value:"",children:"בחר סוג שירות"}),R.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"תנאי תשלום"}),e.jsxs("select",{value:t.payment_terms,onChange:s=>d({...t,payment_terms:s.target.value}),className:"input",children:[e.jsx("option",{value:"",children:"בחר תנאי תשלום"}),B.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"סטטוס"}),e.jsx("select",{value:t.status,onChange:s=>d({...t,status:s.target.value}),className:"input",children:W.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"הערות"}),e.jsx("textarea",{value:t.notes,onChange:s=>d({...t,notes:s.target.value}),className:"input",rows:3,placeholder:"הערות..."})]})]}):e.jsxs("dl",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm text-gray-500",children:"ח.פ"}),e.jsx("dd",{className:"font-medium",children:(a==null?void 0:a.business_id)||"-"})]}),(a==null?void 0:a.address)&&e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm text-gray-500",children:"כתובת"}),e.jsxs("dd",{className:"font-medium",children:[a.address,a.city?`, ${a.city}`:""]})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm text-gray-500",children:"סוג שירות"}),e.jsx("dd",{className:"font-medium",children:((I=R.find(s=>s.value===(a==null?void 0:a.service_type)))==null?void 0:I.label)||(a==null?void 0:a.service_type)||"-"})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm text-gray-500",children:"תנאי תשלום"}),e.jsx("dd",{className:"font-medium",children:((L=B.find(s=>s.value===(a==null?void 0:a.payment_terms)))==null?void 0:L.label)||(a==null?void 0:a.payment_terms)||"-"})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm text-gray-500",children:"סטטוס"}),e.jsx("dd",{children:e.jsx("span",{className:`badge ${(a==null?void 0:a.status)==="active"?"badge-success":"badge-gray"}`,children:(($=W.find(s=>s.value===(a==null?void 0:a.status)))==null?void 0:$.label)||(a==null?void 0:a.status)})})]}),(a==null?void 0:a.notes)&&e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm text-gray-500",children:"הערות"}),e.jsx("dd",{className:"font-medium text-sm whitespace-pre-wrap",children:a.notes})]})]})]}),((z=l==null?void 0:l.invoices)==null?void 0:z.length)>0&&e.jsxs("div",{className:"card",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"חשבוניות אחרונות"}),e.jsx("div",{className:"space-y-2",children:l.invoices.slice(0,5).map(s=>{var v;return e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("span",{children:["#",s.invoice_number]}),e.jsxs("span",{className:s.status==="paid"?"text-green-600":"text-yellow-600",children:["₪",(v=s.total_amount)==null?void 0:v.toLocaleString()]})]},s.id)})})]})]})]})]})}export{Se as default};
