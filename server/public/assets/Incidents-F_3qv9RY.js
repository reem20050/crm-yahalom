import{c as pe,g as he,i as ge,r,d as x,h as S,j as e,S as je,A as ye,X as ie,e as Ne,a2 as o,m as be,N as ve}from"./index-DVPKYaqZ.js";import{S as fe}from"./shield-BAUQc-9_.js";import{P as _e}from"./plus-BMlu7TrJ.js";import{E as we}from"./eye-Z4mQnnbo.js";import{C as Ce}from"./check-circle-0K905Q3K.js";/**
 * @license lucide-react v0.302.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Se=pe("MessageSquarePlus",[["path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z",key:"1lielz"}],["path",{d:"M12 7v6",key:"lw1j43"}],["path",{d:"M9 10h6",key:"9gxzsh"}]]),k={theft:"גניבה",break_in:"פריצה",trespassing:"חדירה",vandalism:"ונדליזם",suspicious_activity:"פעילות חשודה",accident:"תאונה",injury:"פגיעה",alarm:"אזעקה",fire:"שריפה",violence:"אלימות",other:"אחר"},g={critical:"קריטי",high:"גבוה",medium:"בינוני",low:"נמוך"},ne={critical:"bg-red-100 text-red-800 border-red-300",high:"bg-orange-100 text-orange-800 border-orange-300",medium:"bg-yellow-100 text-yellow-800 border-yellow-300",low:"bg-green-100 text-green-800 border-green-300"},q={open:"פתוח",investigating:"בחקירה",resolved:"טופל",closed:"סגור"},re={open:"badge-danger",investigating:"badge-warning",resolved:"badge-success",closed:"bg-gray-100 text-gray-700"};function Pe(){var I,O,L,z,E,$,U,B,R,D,H,V,X,G,J,W,Y,Z,ee,se,te,ae,le;const d=he(),{can:F}=ge(),[j,ce]=r.useState(""),[y,de]=r.useState(""),[N,oe]=r.useState(""),[xe,m]=r.useState(!1),[c,b]=r.useState(null),[u,K]=r.useState(null),[p,M]=r.useState(""),[h,P]=r.useState(""),[t,l]=r.useState({title:"",incident_type:"suspicious_activity",severity:"medium",customer_id:"",site_id:"",incident_date:new Date().toISOString().split("T")[0],incident_time:new Date().toTimeString().slice(0,5),description:"",location_details:"",police_called:!1,police_report_number:"",ambulance_called:!1,injuries_reported:!1,property_damage:!1,actions_taken:""}),{data:v,isLoading:me}=x({queryKey:["incidents",{search:j,status:y,severity:N}],queryFn:()=>o.getAll({search:j||void 0,status:y||void 0,severity:N||void 0}).then(s=>s.data)}),{data:i}=x({queryKey:["incidents-stats"],queryFn:()=>o.getStats().then(s=>s.data)}),{data:a}=x({queryKey:["incident",c],queryFn:()=>o.getOne(c).then(s=>s.data),enabled:!!c}),{data:f}=x({queryKey:["customers-list"],queryFn:()=>be.getAll().then(s=>s.data)}),{data:_}=x({queryKey:["sites",t.customer_id],queryFn:()=>ve.getByCustomer(t.customer_id).then(s=>s.data),enabled:!!t.customer_id}),w=S({mutationFn:s=>u?o.update(u,s):o.create(s),onSuccess:()=>{d.invalidateQueries({queryKey:["incidents"]}),d.invalidateQueries({queryKey:["incidents-stats"]}),m(!1),K(null),Q()}}),T=S({mutationFn:({id:s,text:n})=>o.addUpdate(s,n),onSuccess:()=>{d.invalidateQueries({queryKey:["incident",c]}),d.invalidateQueries({queryKey:["incidents"]}),M("")}}),C=S({mutationFn:({id:s,resolution:n})=>o.resolve(s,n),onSuccess:()=>{d.invalidateQueries({queryKey:["incident",c]}),d.invalidateQueries({queryKey:["incidents"]}),d.invalidateQueries({queryKey:["incidents-stats"]}),P(""),b(null)}}),Q=()=>{l({title:"",incident_type:"suspicious_activity",severity:"medium",customer_id:"",site_id:"",incident_date:new Date().toISOString().split("T")[0],incident_time:new Date().toTimeString().slice(0,5),description:"",location_details:"",police_called:!1,police_report_number:"",ambulance_called:!1,injuries_reported:!1,property_damage:!1,actions_taken:""})},ue=s=>{s.preventDefault(),w.mutate(t)},A=(v==null?void 0:v.incidents)||[];return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold text-gray-900 flex items-center gap-2",children:[e.jsx(fe,{className:"w-7 h-7 text-red-500"}),"אירועי אבטחה"]}),e.jsx("p",{className:"text-gray-500",children:"ניהול ותיעוד אירועי אבטחה"})]}),F("incidents:create")&&e.jsxs("button",{onClick:()=>{Q(),K(null),m(!0)},className:"btn-primary flex items-center gap-2",children:[e.jsx(_e,{className:"w-4 h-4"}),"דיווח חדש"]})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"card !p-4 text-center",children:[e.jsx("p",{className:"text-2xl font-bold text-red-600",children:(i==null?void 0:i.open_count)||0}),e.jsx("p",{className:"text-sm text-gray-500",children:"פתוחים"})]}),e.jsxs("div",{className:"card !p-4 text-center",children:[e.jsx("p",{className:"text-2xl font-bold text-yellow-600",children:(i==null?void 0:i.investigating_count)||0}),e.jsx("p",{className:"text-sm text-gray-500",children:"בחקירה"})]}),e.jsxs("div",{className:"card !p-4 text-center",children:[e.jsx("p",{className:"text-2xl font-bold text-green-600",children:(i==null?void 0:i.resolved_this_month)||0}),e.jsx("p",{className:"text-sm text-gray-500",children:"טופלו החודש"})]}),e.jsxs("div",{className:"card !p-4 text-center",children:[e.jsx("p",{className:"text-2xl font-bold text-red-800",children:(i==null?void 0:i.critical_open)||0}),e.jsx("p",{className:"text-sm text-gray-500",children:"קריטיים"})]})]}),e.jsx("div",{className:"card !p-4",children:e.jsxs("div",{className:"flex flex-wrap gap-4",children:[e.jsxs("div",{className:"flex-1 min-w-[200px] relative",children:[e.jsx(je,{className:"absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"חיפוש...",value:j,onChange:s=>ce(s.target.value),className:"input pr-10 w-full"})]}),e.jsxs("select",{value:y,onChange:s=>de(s.target.value),className:"input",children:[e.jsx("option",{value:"",children:"כל הסטטוסים"}),Object.entries(q).map(([s,n])=>e.jsx("option",{value:s,children:n},s))]}),e.jsxs("select",{value:N,onChange:s=>oe(s.target.value),className:"input",children:[e.jsx("option",{value:"",children:"כל החומרות"}),Object.entries(g).map(([s,n])=>e.jsx("option",{value:s,children:n},s))]})]})}),me?e.jsx("div",{className:"flex justify-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-4 border-primary-500 border-t-transparent"})}):A.length===0?e.jsxs("div",{className:"text-center py-12 text-gray-500",children:[e.jsx(ye,{className:"w-12 h-12 mx-auto mb-4 text-gray-300"}),e.jsx("p",{children:"לא נמצאו אירועי אבטחה"})]}):e.jsx("div",{className:"card overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 border-b",children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-right px-4 py-3 text-sm font-medium text-gray-500",children:"חומרה"}),e.jsx("th",{className:"text-right px-4 py-3 text-sm font-medium text-gray-500",children:"כותרת"}),e.jsx("th",{className:"text-right px-4 py-3 text-sm font-medium text-gray-500",children:"סוג"}),e.jsx("th",{className:"text-right px-4 py-3 text-sm font-medium text-gray-500",children:"אתר / לקוח"}),e.jsx("th",{className:"text-right px-4 py-3 text-sm font-medium text-gray-500",children:"תאריך"}),e.jsx("th",{className:"text-right px-4 py-3 text-sm font-medium text-gray-500",children:"סטטוס"}),e.jsx("th",{className:"text-right px-4 py-3 text-sm font-medium text-gray-500",children:"פעולות"})]})}),e.jsx("tbody",{className:"divide-y",children:A.map(s=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-3",children:e.jsx("span",{className:`px-2 py-1 rounded text-xs font-bold border ${ne[s.severity]||""}`,children:g[s.severity]||s.severity})}),e.jsx("td",{className:"px-4 py-3 font-medium text-gray-900",children:s.title}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-600",children:k[s.incident_type]||s.incident_type}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-600",children:s.site_name||s.company_name||"-"}),e.jsxs("td",{className:"px-4 py-3 text-sm text-gray-600",children:[s.incident_date," ",s.incident_time]}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("span",{className:`badge ${re[s.status]||""}`,children:q[s.status]||s.status})}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("div",{className:"flex gap-1",children:e.jsx("button",{onClick:()=>b(s.id),className:"p-1.5 rounded hover:bg-gray-100",title:"צפה",children:e.jsx(we,{className:"w-4 h-4 text-gray-500"})})})})]},s.id))})]})})}),xe&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto m-4",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b",children:[e.jsx("h2",{className:"text-lg font-bold",children:u?"עריכת אירוע":"דיווח אירוע אבטחה"}),e.jsx("button",{onClick:()=>m(!1),className:"p-2 hover:bg-gray-100 rounded-lg",children:e.jsx(ie,{className:"w-5 h-5"})})]}),e.jsxs("form",{onSubmit:ue,className:"p-6 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"label",children:"כותרת *"}),e.jsx("input",{type:"text",required:!0,value:t.title,onChange:s=>l({...t,title:s.target.value}),className:"input w-full",placeholder:"תיאור קצר של האירוע"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"סוג אירוע *"}),e.jsx("select",{value:t.incident_type,onChange:s=>l({...t,incident_type:s.target.value}),className:"input w-full",children:Object.entries(k).map(([s,n])=>e.jsx("option",{value:s,children:n},s))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"חומרה *"}),e.jsx("select",{value:t.severity,onChange:s=>l({...t,severity:s.target.value}),className:"input w-full",children:Object.entries(g).map(([s,n])=>e.jsx("option",{value:s,children:n},s))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"לקוח"}),e.jsxs("select",{value:t.customer_id,onChange:s=>l({...t,customer_id:s.target.value,site_id:""}),className:"input w-full",children:[e.jsx("option",{value:"",children:"בחר לקוח"}),((f==null?void 0:f.customers)||[]).map(s=>e.jsx("option",{value:s.id,children:s.company_name},s.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"אתר"}),e.jsxs("select",{value:t.site_id,onChange:s=>l({...t,site_id:s.target.value}),className:"input w-full",disabled:!t.customer_id,children:[e.jsx("option",{value:"",children:"בחר אתר"}),((_==null?void 0:_.sites)||[]).map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"תאריך *"}),e.jsx("input",{type:"date",required:!0,value:t.incident_date,onChange:s=>l({...t,incident_date:s.target.value}),className:"input w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"שעה *"}),e.jsx("input",{type:"time",required:!0,value:t.incident_time,onChange:s=>l({...t,incident_time:s.target.value}),className:"input w-full"})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"label",children:"תיאור מפורט *"}),e.jsx("textarea",{required:!0,rows:3,value:t.description,onChange:s=>l({...t,description:s.target.value}),className:"input w-full",placeholder:"תאר את האירוע בפירוט..."})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"label",children:"מיקום מדויק באתר"}),e.jsx("input",{type:"text",value:t.location_details,onChange:s=>l({...t,location_details:s.target.value}),className:"input w-full",placeholder:"למשל: שער כניסה ראשי, חניון B"})]}),e.jsxs("div",{className:"md:col-span-2 grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:t.police_called,onChange:s=>l({...t,police_called:s.target.checked}),className:"rounded"}),e.jsx("span",{className:"text-sm",children:"הוזעקה משטרה"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:t.ambulance_called,onChange:s=>l({...t,ambulance_called:s.target.checked}),className:"rounded"}),e.jsx("span",{className:"text-sm",children:"הוזעק אמבולנס"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:t.injuries_reported,onChange:s=>l({...t,injuries_reported:s.target.checked}),className:"rounded"}),e.jsx("span",{className:"text-sm",children:"דווח על נפגעים"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:t.property_damage,onChange:s=>l({...t,property_damage:s.target.checked}),className:"rounded"}),e.jsx("span",{className:"text-sm",children:"נזק לרכוש"})]})]}),t.police_called&&e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"label",children:"מספר תיק משטרה"}),e.jsx("input",{type:"text",value:t.police_report_number,onChange:s=>l({...t,police_report_number:s.target.value}),className:"input w-full"})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"label",children:"פעולות שננקטו"}),e.jsx("textarea",{rows:2,value:t.actions_taken,onChange:s=>l({...t,actions_taken:s.target.value}),className:"input w-full",placeholder:"מה נעשה במקום?"})]})]}),e.jsxs("div",{className:"flex gap-3 pt-4 border-t",children:[e.jsx("button",{type:"submit",className:"btn-primary",disabled:w.isPending,children:w.isPending?"שומר...":u?"עדכן":"דווח אירוע"}),e.jsx("button",{type:"button",onClick:()=>m(!1),className:"btn-secondary",children:"ביטול"})]})]})]})}),c&&a&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl w-full max-w-3xl max-h-[90vh] overflow-y-auto m-4",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:`px-2 py-1 rounded text-xs font-bold border ${ne[(I=a.incident)==null?void 0:I.severity]||""}`,children:g[(O=a.incident)==null?void 0:O.severity]}),e.jsx("h2",{className:"text-lg font-bold",children:(L=a.incident)==null?void 0:L.title})]}),e.jsx("button",{onClick:()=>b(null),className:"p-2 hover:bg-gray-100 rounded-lg",children:e.jsx(ie,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"סוג"}),e.jsx("p",{className:"font-medium",children:k[(z=a.incident)==null?void 0:z.incident_type]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"תאריך ושעה"}),e.jsxs("p",{className:"font-medium",children:[(E=a.incident)==null?void 0:E.incident_date," ",($=a.incident)==null?void 0:$.incident_time]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"סטטוס"}),e.jsx("span",{className:`badge ${re[(U=a.incident)==null?void 0:U.status]}`,children:q[(B=a.incident)==null?void 0:B.status]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"אתר"}),e.jsx("p",{className:"font-medium",children:((R=a.incident)==null?void 0:R.site_name)||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"לקוח"}),e.jsx("p",{className:"font-medium",children:((D=a.incident)==null?void 0:D.company_name)||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"מדווח"}),e.jsx("p",{className:"font-medium",children:((H=a.incident)==null?void 0:H.reporter_name)||"-"})]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:"תיאור"}),e.jsx("p",{className:"bg-gray-50 p-3 rounded-lg",children:(V=a.incident)==null?void 0:V.description})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[(X=a.incident)!=null&&X.police_called?e.jsx("span",{className:"badge bg-blue-100 text-blue-800",children:"משטרה הוזעקה"}):null,(G=a.incident)!=null&&G.ambulance_called?e.jsx("span",{className:"badge bg-red-100 text-red-800",children:"אמבולנס הוזעק"}):null,(J=a.incident)!=null&&J.injuries_reported?e.jsx("span",{className:"badge bg-red-100 text-red-800",children:"נפגעים"}):null,(W=a.incident)!=null&&W.property_damage?e.jsx("span",{className:"badge bg-orange-100 text-orange-800",children:"נזק לרכוש"}):null]}),((Y=a.incident)==null?void 0:Y.actions_taken)&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:"פעולות שננקטו"}),e.jsx("p",{className:"bg-green-50 p-3 rounded-lg",children:a.incident.actions_taken})]}),e.jsxs("div",{children:[e.jsxs("h3",{className:"font-semibold text-gray-900 mb-3 flex items-center gap-2",children:[e.jsx(Ne,{className:"w-4 h-4"}),"עדכונים (",((Z=a.updates)==null?void 0:Z.length)||0,")"]}),((ee=a.updates)==null?void 0:ee.length)>0?e.jsx("div",{className:"space-y-3 border-r-2 border-gray-200 pr-4 mr-2",children:a.updates.map(s=>e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute -right-[21px] top-1 w-3 h-3 rounded-full bg-primary-500 border-2 border-white"}),e.jsx("p",{className:"text-sm",children:s.update_text}),e.jsxs("p",{className:"text-xs text-gray-400 mt-1",children:[s.user_name," | ",new Date(s.created_at).toLocaleString("he-IL")]})]},s.id))}):e.jsx("p",{className:"text-sm text-gray-400",children:"אין עדכונים עדיין"}),((se=a.incident)==null?void 0:se.status)!=="closed"&&e.jsxs("div",{className:"mt-4 flex gap-2",children:[e.jsx("input",{type:"text",placeholder:"הוסף עדכון...",value:p,onChange:s=>M(s.target.value),className:"input flex-1"}),e.jsxs("button",{onClick:()=>{p.trim()&&T.mutate({id:c,text:p})},disabled:!p.trim()||T.isPending,className:"btn-primary flex items-center gap-1",children:[e.jsx(Se,{className:"w-4 h-4"}),"עדכן"]})]})]}),F("incidents:resolve")&&((te=a.incident)==null?void 0:te.status)!=="resolved"&&((ae=a.incident)==null?void 0:ae.status)!=="closed"&&e.jsxs("div",{className:"border-t pt-4",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 mb-3 flex items-center gap-2",children:[e.jsx(Ce,{className:"w-4 h-4 text-green-500"}),"סגירת אירוע"]}),e.jsx("textarea",{rows:2,placeholder:"תיאור הפתרון / סיכום...",value:h,onChange:s=>P(s.target.value),className:"input w-full mb-3"}),e.jsx("button",{onClick:()=>{h.trim()&&C.mutate({id:c,resolution:h})},disabled:!h.trim()||C.isPending,className:"bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors",children:C.isPending?"סוגר...":"סגור אירוע"})]}),((le=a.incident)==null?void 0:le.resolution)&&e.jsxs("div",{className:"bg-green-50 border border-green-200 p-4 rounded-lg",children:[e.jsx("p",{className:"text-sm text-green-700 font-medium mb-1",children:"פתרון:"}),e.jsx("p",{children:a.incident.resolution}),a.incident.resolution_date&&e.jsxs("p",{className:"text-xs text-green-600 mt-2",children:["נסגר: ",a.incident.resolution_date]})]})]})]})})]})}export{Pe as default};
