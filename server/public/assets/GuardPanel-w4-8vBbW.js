import{c as w,r as g,e as k,d as j,j as e,L as y,S as N,o as _,A as S,p as L,z as x,s as p}from"./index-DNhSfFTF.js";import{M}from"./map-pin-CnrXv9DV.js";import{C}from"./check-circle-rj1BL297.js";import{L as A}from"./log-in-Cc9ZJbBP.js";function v(){return navigator.geolocation?new Promise(i=>{navigator.geolocation.getCurrentPosition(a=>i({latitude:a.coords.latitude,longitude:a.coords.longitude}),()=>i(null),{enableHighAccuracy:!0,timeout:1e4,maximumAge:6e4})}):Promise.resolve(null)}function b(i){return i?i.slice(0,5):""}function E(i){const a=new Date(i+"T00:00:00");return`יום ${["ראשון","שני","שלישי","רביעי","חמישי","שישי","שבת"][a.getDay()]}, ${a.getDate()}/${a.getMonth()+1}/${a.getFullYear()}`}function I({checkInTime:i}){const[a,l]=g.useState("");return g.useEffect(()=>{const r=()=>{const t=new Date(i).getTime(),u=Date.now(),c=Math.max(0,u-t),o=Math.floor(c/36e5),m=Math.floor(c%36e5/6e4),f=Math.floor(c%6e4/1e3);l(`${String(o).padStart(2,"0")}:${String(m).padStart(2,"0")}:${String(f).padStart(2,"0")}`)};r();const h=setInterval(r,1e3);return()=>clearInterval(h)},[i]),e.jsx("span",{className:"font-mono text-3xl font-bold text-gray-900",children:a})}function F(){const i=w(),[a,l]=g.useState(""),{data:r,isLoading:h}=k({queryKey:["my-active-assignment"],queryFn:()=>p.getMyActiveAssignment().then(s=>s.data),refetchInterval:3e4}),t=r==null?void 0:r.assignment,u=j({mutationFn:async s=>{const n=await v();return p.checkIn(s,n||void 0)},onSuccess:s=>{i.invalidateQueries({queryKey:["my-active-assignment"]});const n=s.data;n!=null&&n.warning?(l(n.warning),x.success("צ'ק-אין בוצע בהצלחה (עם אזהרת מיקום)")):x.success("צ'ק-אין בוצע בהצלחה!")},onError:s=>{var n,d;x.error(((d=(n=s==null?void 0:s.response)==null?void 0:n.data)==null?void 0:d.error)||"שגיאה בצ'ק-אין")}}),c=j({mutationFn:async s=>{const n=await v();return p.checkOut(s,n||void 0)},onSuccess:()=>{i.invalidateQueries({queryKey:["my-active-assignment"]}),x.success("צ'ק-אאוט בוצע בהצלחה!")},onError:s=>{var n,d;x.error(((d=(n=s==null?void 0:s.response)==null?void 0:n.data)==null?void 0:d.error)||"שגיאה בצ'ק-אאוט")}}),o=u.isPending||c.isPending;if(g.useEffect(()=>{if(a){const s=setTimeout(()=>l(""),1e4);return()=>clearTimeout(s)}},[a]),h)return e.jsx("div",{className:"flex items-center justify-center min-h-[60vh]",children:e.jsx(y,{className:"w-10 h-10 animate-spin text-primary-500"})});if(!t)return e.jsx("div",{className:"max-w-md mx-auto mt-12",children:e.jsxs("div",{className:"card text-center py-16 px-8",children:[e.jsx("div",{className:"w-20 h-20 bg-gradient-to-br from-gray-100 to-gray-50 rounded-full flex items-center justify-center mx-auto mb-6",children:e.jsx(N,{className:"w-10 h-10 text-gray-400"})}),e.jsx("h2",{className:"text-xl font-bold text-gray-900 mb-2 font-heading",children:"אין משמרת פעילה"}),e.jsx("p",{className:"text-gray-500",children:"אין לך משמרת מתוכננת להיום, או שהמשמרת טרם שובצה."})]})});const m=t.status==="checked_in",f=t.status==="assigned";return e.jsxs("div",{className:"max-w-md mx-auto mt-8 space-y-6",children:[e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"w-10 h-10 bg-gradient-to-br from-primary-100 to-primary-50 rounded-lg flex items-center justify-center",children:e.jsx(N,{className:"w-5 h-5 text-primary-600"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-bold text-gray-900 font-heading",children:"המשמרת שלי"}),e.jsx("p",{className:"text-sm text-gray-500",children:E(t.date)})]})]}),e.jsxs("div",{className:"space-y-3",children:[t.site_name&&e.jsxs("div",{className:"flex items-center gap-2 text-gray-700",children:[e.jsx(M,{className:"w-4 h-4 text-gray-400 flex-shrink-0"}),e.jsx("span",{className:"font-medium",children:t.site_name}),t.customer_name&&e.jsxs("span",{className:"text-gray-400",children:["(",t.customer_name,")"]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-gray-700",children:[e.jsx(_,{className:"w-4 h-4 text-gray-400 flex-shrink-0"}),e.jsxs("span",{children:[b(t.start_time)," - ",b(t.end_time)]})]}),m&&t.check_in_time&&e.jsxs("div",{className:"flex items-center gap-2 text-green-700",children:[e.jsx(C,{className:"w-4 h-4 text-green-500 flex-shrink-0"}),e.jsxs("span",{children:["נכנסת ב-",new Date(t.check_in_time).toLocaleTimeString("he-IL",{hour:"2-digit",minute:"2-digit"})]})]})]})]}),m&&t.check_in_time&&e.jsxs("div",{className:"card text-center py-6",children:[e.jsx("p",{className:"text-sm text-gray-500 mb-2",children:"זמן במשמרת"}),e.jsx(I,{checkInTime:t.check_in_time})]}),a&&e.jsxs("div",{className:"bg-amber-50 border border-amber-200 text-amber-800 px-4 py-3 rounded-xl flex items-center gap-2",children:[e.jsx(S,{className:"w-5 h-5 flex-shrink-0"}),e.jsx("span",{className:"text-sm",children:a})]}),f&&e.jsx("button",{onClick:()=>u.mutate(t.assignment_id),disabled:o,className:"w-full py-6 rounded-2xl text-white text-2xl font-bold bg-green-500 hover:bg-green-600 active:bg-green-700 disabled:opacity-50 transition-all shadow-lg flex items-center justify-center gap-3",children:o?e.jsx(y,{className:"w-8 h-8 animate-spin"}):e.jsxs(e.Fragment,{children:[e.jsx(A,{className:"w-8 h-8"}),"צ'ק-אין"]})}),m&&e.jsx("button",{onClick:()=>c.mutate(t.assignment_id),disabled:o,className:"w-full py-6 rounded-2xl text-white text-2xl font-bold bg-orange-500 hover:bg-orange-600 active:bg-orange-700 disabled:opacity-50 transition-all shadow-lg flex items-center justify-center gap-3",children:o?e.jsx(y,{className:"w-8 h-8 animate-spin"}):e.jsxs(e.Fragment,{children:[e.jsx(L,{className:"w-8 h-8"}),"צ'ק-אאוט"]})}),e.jsx("p",{className:"text-center text-xs text-gray-400",children:"המערכת תבקש את המיקום שלך לצורך אימות"})]})}export{F as default};
