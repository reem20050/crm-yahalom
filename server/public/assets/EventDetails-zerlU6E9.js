import{k as O,u as R,h as T,r as u,d as K,i as x,j as e,P as W,X as Q,e as X,C as B,U as G,z as r,W as m,t as H}from"./index-C0i1J-sF.js";import{A as J,S as V}from"./save-D1RqkBGf.js";import{P as Y}from"./pencil-D27-0zXF.js";import{C as Z}from"./check-circle-ZXk8X-GO.js";import{T as ee}from"./trash-2-DuHHXB84.js";import{M as se}from"./map-pin-D0IwVJkI.js";import{S as ae}from"./shield-BBE-cGgr.js";import{C as te}from"./car-1_hVNyhj.js";import{U as le}from"./user-plus-BYAFJ-xS.js";import{P as ie}from"./phone-DXDS9urK.js";const M=[{value:"quote",label:"הצעת מחיר"},{value:"approved",label:"מאושר"},{value:"staffed",label:"מאויש"},{value:"completed",label:"הושלם"},{value:"cancelled",label:"בוטל"}],ne={quote:"badge-warning",approved:"badge-info",staffed:"badge-info",completed:"badge-success",cancelled:"badge-gray"};function ge(){var C,k,P,S,E,F;const{id:n}=O(),y=R(),c=T(),[d,h]=u.useState(!1),[t,i]=u.useState({}),[o,f]=u.useState(!1),[A,p]=u.useState(!1),{data:l,isLoading:D}=K({queryKey:["event",n],queryFn:()=>m.getOne(n).then(a=>a.data),enabled:!!n}),{data:j}=K({queryKey:["employees","active"],queryFn:()=>H.getAll({status:"active"}).then(a=>a.data),enabled:o}),s=l==null?void 0:l.event;u.useEffect(()=>{s&&d&&i({event_name:s.event_name||"",event_date:s.event_date||"",start_time:s.start_time||"",end_time:s.end_time||"",location:s.location||"",address:s.address||"",required_guards:s.required_guards||0,event_type:s.event_type||"",expected_attendance:s.expected_attendance||"",price:s.price||"",requires_weapon:s.requires_weapon||!1,requires_vehicle:s.requires_vehicle||!1,special_equipment:s.special_equipment||"",notes:s.notes||"",company_name:s.company_name||""})},[s,d]);const g=x({mutationFn:a=>m.update(n,a),onSuccess:()=>{c.invalidateQueries({queryKey:["event",n]}),c.invalidateQueries({queryKey:["events"]}),r.success("האירוע עודכן בהצלחה"),h(!1)},onError:()=>{r.error("שגיאה בעדכון האירוע")}}),v=x({mutationFn:a=>m.update(n,{status:a}),onSuccess:()=>{c.invalidateQueries({queryKey:["event",n]}),c.invalidateQueries({queryKey:["events"]}),r.success("סטטוס עודכן")},onError:()=>{r.error("שגיאה בעדכון סטטוס")}}),N=x({mutationFn:()=>m.complete(n),onSuccess:()=>{c.invalidateQueries({queryKey:["event",n]}),c.invalidateQueries({queryKey:["events"]}),r.success("האירוע סומן כהושלם")},onError:()=>{r.error("שגיאה בסימון האירוע כהושלם")}}),b=x({mutationFn:()=>m.delete(n),onSuccess:()=>{c.invalidateQueries({queryKey:["events"]}),r.success("האירוע נמחק"),y("/events")},onError:()=>{r.error("שגיאה במחיקת האירוע")}}),_=x({mutationFn:a=>m.assign(n,a),onSuccess:()=>{c.invalidateQueries({queryKey:["event",n]}),r.success("עובד שובץ בהצלחה"),f(!1)},onError:()=>{r.error("שגיאה בשיבוץ עובד")}}),w=x({mutationFn:a=>m.unassign(n,a),onSuccess:()=>{c.invalidateQueries({queryKey:["event",n]}),r.success("שיבוץ עובד הוסר")},onError:()=>{r.error("שגיאה בהסרת שיבוץ")}}),U=()=>{const a={...t};a.price&&(a.price=Number(a.price)),a.required_guards&&(a.required_guards=Number(a.required_guards)),a.expected_attendance&&(a.expected_attendance=Number(a.expected_attendance)),g.mutate(a)},z=()=>{h(!1),i({})},$=a=>{_.mutate({employee_id:a.id,role:a.role||"מאבטח"})},I=()=>{b.mutate(),p(!1)},L=((l==null?void 0:l.assignments)||[]).map(a=>a.employee_id),q=((j==null?void 0:j.employees)||[]).filter(a=>!L.includes(a.id));return D?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-2 border-primary-600 border-t-transparent"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("button",{onClick:()=>y("/events"),className:"flex items-center gap-2 text-gray-600 hover:text-gray-900",children:[e.jsx(J,{className:"w-5 h-5"}),"חזרה לאירועים"]}),e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:"w-16 h-16 bg-orange-100 rounded-xl flex items-center justify-center",children:e.jsx(W,{className:"w-8 h-8 text-orange-600"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:s==null?void 0:s.event_name}),e.jsx("p",{className:"text-gray-500",children:s==null?void 0:s.company_name}),(s==null?void 0:s.status)&&e.jsx("span",{className:`badge mt-1 ${ne[s.status]||"badge-gray"}`,children:((C=M.find(a=>a.value===s.status))==null?void 0:C.label)||s.status})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[!d&&e.jsxs("button",{onClick:()=>h(!0),className:"btn-secondary flex items-center gap-2",children:[e.jsx(Y,{className:"w-4 h-4"}),"עריכה"]}),d&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:U,disabled:g.isPending,className:"btn-primary flex items-center gap-2",children:[e.jsx(V,{className:"w-4 h-4"}),g.isPending?"שומר...":"שמור"]}),e.jsxs("button",{onClick:z,className:"btn-secondary flex items-center gap-2",children:[e.jsx(Q,{className:"w-4 h-4"}),"ביטול"]})]}),!d&&(s==null?void 0:s.status)!=="completed"&&(s==null?void 0:s.status)!=="cancelled"&&e.jsxs("button",{onClick:()=>N.mutate(),disabled:N.isPending,className:"btn-success flex items-center gap-2",children:[e.jsx(Z,{className:"w-4 h-4"}),N.isPending?"מעדכן...":"סמן כהושלם"]}),!d&&e.jsxs("button",{onClick:()=>p(!0),className:"btn-danger flex items-center gap-2",children:[e.jsx(ee,{className:"w-4 h-4"}),"מחק אירוע"]})]})]}),A&&e.jsx("div",{className:"fixed inset-0 bg-gray-900/40 backdrop-blur-sm animate-fade-in z-50 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white rounded-xl p-6 max-w-md w-full mx-4 space-y-4",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-900",children:"מחיקת אירוע"}),e.jsxs("p",{className:"text-gray-600",children:['האם אתה בטוח שברצונך למחוק את האירוע "',s==null?void 0:s.event_name,'"? פעולה זו אינה ניתנת לביטול.']}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{onClick:()=>p(!1),className:"btn-secondary",children:"ביטול"}),e.jsx("button",{onClick:I,disabled:b.isPending,className:"btn-danger",children:b.isPending?"מוחק...":"מחק"})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs("div",{className:"card",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"פרטי האירוע"}),d?e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"שם האירוע"}),e.jsx("input",{value:t.event_name,onChange:a=>i({...t,event_name:a.target.value}),className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"שם חברה"}),e.jsx("input",{value:t.company_name,onChange:a=>i({...t,company_name:a.target.value}),className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"תאריך"}),e.jsx("input",{type:"date",value:t.event_date,onChange:a=>i({...t,event_date:a.target.value}),className:"input",dir:"ltr"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"סוג אירוע"}),e.jsx("input",{value:t.event_type,onChange:a=>i({...t,event_type:a.target.value}),className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"שעת התחלה"}),e.jsx("input",{type:"time",value:t.start_time,onChange:a=>i({...t,start_time:a.target.value}),className:"input",dir:"ltr"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"שעת סיום"}),e.jsx("input",{type:"time",value:t.end_time,onChange:a=>i({...t,end_time:a.target.value}),className:"input",dir:"ltr"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"מיקום"}),e.jsx("input",{value:t.location,onChange:a=>i({...t,location:a.target.value}),className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"כתובת"}),e.jsx("input",{value:t.address,onChange:a=>i({...t,address:a.target.value}),className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"מאבטחים נדרשים"}),e.jsx("input",{type:"number",value:t.required_guards,onChange:a=>i({...t,required_guards:a.target.value}),className:"input",dir:"ltr",min:0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"קהל צפוי"}),e.jsx("input",{type:"number",value:t.expected_attendance,onChange:a=>i({...t,expected_attendance:a.target.value}),className:"input",dir:"ltr",min:0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"מחיר (₪)"}),e.jsx("input",{type:"number",value:t.price,onChange:a=>i({...t,price:a.target.value}),className:"input",dir:"ltr",min:0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"ציוד מיוחד"}),e.jsx("input",{value:t.special_equipment,onChange:a=>i({...t,special_equipment:a.target.value}),className:"input"})]}),e.jsxs("div",{className:"col-span-2 flex items-center gap-6",children:[e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:t.requires_weapon,onChange:a=>i({...t,requires_weapon:a.target.checked}),className:"w-4 h-4 text-primary-600 rounded"}),e.jsx("span",{children:"דורש נשק"})]}),e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:t.requires_vehicle,onChange:a=>i({...t,requires_vehicle:a.target.checked}),className:"w-4 h-4 text-primary-600 rounded"}),e.jsx("span",{children:"דורש רכב"})]})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"label",children:"הערות"}),e.jsx("textarea",{value:t.notes,onChange:a=>i({...t,notes:a.target.value}),className:"input",rows:3})]})]})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(X,{className:"w-5 h-5 text-gray-400"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"תאריך"}),e.jsx("p",{className:"font-medium",children:s==null?void 0:s.event_date})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(B,{className:"w-5 h-5 text-gray-400"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"שעות"}),e.jsxs("p",{className:"font-medium",children:[s==null?void 0:s.start_time," - ",s==null?void 0:s.end_time]})]})]}),e.jsxs("div",{className:"flex items-center gap-3 col-span-2",children:[e.jsx(se,{className:"w-5 h-5 text-gray-400"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"מיקום"}),e.jsx("p",{className:"font-medium",children:s==null?void 0:s.location}),(s==null?void 0:s.address)&&e.jsx("p",{className:"text-sm text-gray-500",children:s.address})]})]})]}),e.jsxs("div",{className:"flex items-center gap-4 mt-4 pt-4 border-t",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(G,{className:"w-5 h-5 text-gray-400"}),e.jsxs("span",{children:[s==null?void 0:s.required_guards," מאבטחים"]})]}),(s==null?void 0:s.requires_weapon)&&e.jsxs("div",{className:"flex items-center gap-2 text-yellow-600",children:[e.jsx(ae,{className:"w-5 h-5"}),e.jsx("span",{children:"דורש נשק"})]}),(s==null?void 0:s.requires_vehicle)&&e.jsxs("div",{className:"flex items-center gap-2 text-blue-600",children:[e.jsx(te,{className:"w-5 h-5"}),e.jsx("span",{children:"דורש רכב"})]})]})]})]}),e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"צוות משובץ"}),(s==null?void 0:s.status)!=="completed"&&(s==null?void 0:s.status)!=="cancelled"&&e.jsxs("button",{onClick:()=>f(!o),className:"btn-primary text-sm flex items-center gap-1 px-3 py-1.5",children:[o?e.jsx(Q,{className:"w-4 h-4"}):e.jsx(le,{className:"w-4 h-4"}),o?"ביטול":"שבץ עובד"]})]}),o&&e.jsxs("div",{className:"mb-4 p-4 bg-blue-50 rounded-lg",children:[e.jsx("p",{className:"text-sm font-medium mb-2",children:"בחר עובד לשיבוץ:"}),q.length>0?e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto",children:q.map(a=>e.jsxs("button",{onClick:()=>$(a),disabled:_.isPending,className:"w-full flex items-center justify-between p-3 bg-white rounded-lg hover:bg-gray-50 transition-colors text-right",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium",children:[a.first_name," ",a.last_name]}),e.jsx("p",{className:"text-sm text-gray-500",children:a.role||"מאבטח"})]}),e.jsx("span",{className:"text-sm text-gray-500",dir:"ltr",children:a.phone})]},a.id))}):e.jsx("p",{className:"text-gray-500 text-sm text-center py-2",children:"אין עובדים זמינים לשיבוץ"})]}),((k=l==null?void 0:l.assignments)==null?void 0:k.length)>0?e.jsx("div",{className:"space-y-3",children:l.assignments.map(a=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:a.employee_name}),e.jsx("p",{className:"text-sm text-gray-500",children:a.role||"מאבטח"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("a",{href:`tel:${a.employee_phone}`,className:"flex items-center gap-1 text-primary-600 text-sm",children:[e.jsx(ie,{className:"w-4 h-4"}),a.employee_phone]}),(s==null?void 0:s.status)!=="completed"&&(s==null?void 0:s.status)!=="cancelled"&&e.jsx("button",{onClick:()=>w.mutate(a.id),disabled:w.isPending,className:"text-red-500 hover:text-red-700 text-sm font-medium px-2 py-1 rounded hover:bg-red-50 transition-colors",children:"הסר"})]})]},a.id))}):e.jsx("p",{className:"text-gray-500 text-center py-4",children:"אין עובדים משובצים"})]}),!d&&(s==null?void 0:s.notes)&&e.jsxs("div",{className:"card",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"הערות"}),e.jsx("p",{className:"text-gray-700 whitespace-pre-wrap",children:s.notes})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"card",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"סטטוס ותשלום"}),e.jsxs("dl",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm text-gray-500 mb-1",children:"סטטוס"}),e.jsx("dd",{children:e.jsx("select",{value:(s==null?void 0:s.status)||"",onChange:a=>v.mutate(a.target.value),disabled:v.isPending,className:"input",children:M.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))})})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm text-gray-500",children:"סוג אירוע"}),e.jsx("dd",{className:"font-medium",children:(s==null?void 0:s.event_type)||"-"})]}),(s==null?void 0:s.expected_attendance)&&e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm text-gray-500",children:"קהל צפוי"}),e.jsxs("dd",{className:"font-medium",children:[s.expected_attendance," אנשים"]})]}),(s==null?void 0:s.price)&&e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm text-gray-500",children:"מחיר"}),e.jsxs("dd",{className:"font-bold text-lg",children:["₪",s.price.toLocaleString()]})]})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"סיכום איוש"}),e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-sm text-gray-500",children:"נדרשים"}),e.jsx("span",{className:"font-medium",children:(s==null?void 0:s.required_guards)||0})]}),e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-sm text-gray-500",children:"משובצים"}),e.jsx("span",{className:"font-medium",children:((P=l==null?void 0:l.assignments)==null?void 0:P.length)||0})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-gray-500",children:"חסרים"}),e.jsx("span",{className:`font-bold ${((s==null?void 0:s.required_guards)||0)-(((S=l==null?void 0:l.assignments)==null?void 0:S.length)||0)>0?"text-red-600":"text-green-600"}`,children:Math.max(0,((s==null?void 0:s.required_guards)||0)-(((E=l==null?void 0:l.assignments)==null?void 0:E.length)||0))})]}),((s==null?void 0:s.required_guards)||0)<=(((F=l==null?void 0:l.assignments)==null?void 0:F.length)||0)&&e.jsx("p",{className:"text-green-600 text-sm mt-2 font-medium text-center",children:"האירוע מאויש במלואו"})]}),!d&&(s==null?void 0:s.special_equipment)&&e.jsxs("div",{className:"card",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"ציוד מיוחד"}),e.jsx("p",{className:"text-gray-700",children:s.special_equipment})]})]})]})]})}export{ge as default};
