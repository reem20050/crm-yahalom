import{j as e,h as v,r as n,d as p,i as w,z as g,a9 as c,S as C,L as S,aa as k}from"./index-D-jMUT0A.js";import{G as q,a as M,M as _,I as $}from"./GoogleMapProvider-AFk5H4M7.js";import{R as E}from"./refresh-cw-CNhQ4CrP.js";import{M as z}from"./map-pin-C6hTMJ4i.js";import{S as y}from"./shield-BwdOBKRw.js";import{E as A}from"./external-link-D1eIB_qa.js";const G={width:"100%",height:"100%"},K={lat:31.5,lng:34.8};function L(){const m=v(),[t,i]=n.useState(null),[a,j]=n.useState(""),[l,b]=n.useState(!0),{data:o=[],isLoading:P}=p({queryKey:["sites-with-coordinates"],queryFn:()=>c.getWithCoordinates().then(s=>s.data)}),{data:N=[]}=p({queryKey:["sites-all"],queryFn:()=>c.getAll().then(s=>s.data)}),d=w({mutationFn:()=>c.geocodeAll(),onSuccess:s=>{m.invalidateQueries({queryKey:["sites-with-coordinates"]}),m.invalidateQueries({queryKey:["sites-all"]}),g.success(`${s.data.success} אתרים עודכנו, ${s.data.failed} נכשלו`)},onError:()=>g.error("שגיאה ב-geocoding")}),x=N.length-o.length,h=o.filter(s=>{var r,u;return!a||s.name.includes(a)||s.company_name.includes(a)||((r=s.city)==null?void 0:r.includes(a))||((u=s.address)==null?void 0:u.includes(a))}),f=n.useCallback((s,r)=>{window.open(`https://www.google.com/maps/dir/?api=1&destination=${s},${r}`,"_blank")},[]);return e.jsxs("div",{className:"h-[calc(100vh-4rem)] flex",children:[l&&e.jsxs("div",{className:"w-80 bg-white border-l border-gray-200 overflow-y-auto flex-shrink-0",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200",children:[e.jsxs("h2",{className:"text-lg font-bold text-gray-900 mb-3",children:["אתרים (",o.length,")"]}),e.jsxs("div",{className:"relative",children:[e.jsx(C,{className:"absolute right-3 top-2.5 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"text",value:a,onChange:s=>j(s.target.value),placeholder:"חיפוש אתר...",className:"input pr-10 text-sm"})]}),x>0&&e.jsxs("div",{className:"mt-3 p-2 bg-amber-50 rounded-lg border border-amber-200",children:[e.jsxs("p",{className:"text-xs text-amber-700 mb-2",children:[x," אתרים בלי קואורדינטות"]}),e.jsxs("button",{onClick:()=>d.mutate(),disabled:d.isPending,className:"btn-primary text-xs px-2 py-1 flex items-center gap-1",children:[d.isPending?e.jsx(E,{className:"w-3 h-3 animate-spin"}):e.jsx(z,{className:"w-3 h-3"}),"עדכן קואורדינטות"]})]})]}),e.jsx("div",{className:"divide-y divide-gray-100",children:h.map(s=>e.jsxs("button",{onClick:()=>i(s),className:`w-full text-right p-3 hover:bg-gray-50 transition-colors ${(t==null?void 0:t.id)===s.id?"bg-primary-50 border-r-2 border-primary-500":""}`,children:[e.jsx("p",{className:"font-medium text-sm text-gray-900",children:s.name}),e.jsx("p",{className:"text-xs text-gray-500",children:s.company_name}),e.jsxs("p",{className:"text-xs text-gray-400 mt-1",children:[s.address,", ",s.city]}),s.requires_weapon===1&&e.jsxs("span",{className:"inline-flex items-center gap-1 mt-1 text-xs text-red-600",children:[e.jsx(y,{className:"w-3 h-3"})," דורש נשק"]})]},s.id))})]}),e.jsxs("div",{className:"flex-1 relative",children:[e.jsx("button",{onClick:()=>b(!l),className:"absolute top-3 right-3 z-10 bg-white shadow-lg rounded-lg px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50",children:l?"הסתר רשימה":"הצג רשימה"}),e.jsxs(M,{mapContainerStyle:G,center:K,zoom:8,options:{gestureHandling:"greedy"},children:[h.map(s=>e.jsx(_,{position:{lat:s.latitude,lng:s.longitude},onClick:()=>i(s),title:s.name},s.id)),t&&e.jsx($,{position:{lat:t.latitude,lng:t.longitude},onCloseClick:()=>i(null),children:e.jsxs("div",{className:"p-2 min-w-[200px]",dir:"rtl",children:[e.jsx("h3",{className:"font-bold text-gray-900",children:t.name}),e.jsx("p",{className:"text-sm text-primary-600 mb-1",children:t.company_name}),e.jsxs("p",{className:"text-sm text-gray-600",children:[t.address,", ",t.city]}),t.requires_weapon===1&&e.jsxs("p",{className:"text-xs text-red-600 flex items-center gap-1 mt-1",children:[e.jsx(y,{className:"w-3 h-3"})," דורש נשק"]}),t.requirements&&e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:t.requirements}),e.jsxs("div",{className:"flex gap-2 mt-3",children:[e.jsxs(S,{to:`/customers/${t.customer_id}`,className:"text-xs text-primary-600 hover:underline flex items-center gap-1",children:[e.jsx(A,{className:"w-3 h-3"})," פרטי לקוח"]}),e.jsxs("button",{onClick:()=>f(t.latitude,t.longitude),className:"text-xs text-green-600 hover:underline flex items-center gap-1",children:[e.jsx(k,{className:"w-3 h-3"})," ניווט"]})]})]})})]})]})]})}function T(){return e.jsx(q,{children:e.jsx(L,{})})}export{T as default};
