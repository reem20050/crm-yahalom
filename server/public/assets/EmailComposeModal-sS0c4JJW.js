import{c as T,r as v,e as D,d as B,j as e,o as S,E,U as _,z as p,G as C,X as A,L as $,H as F}from"./index-DNhSfFTF.js";import{P as k}from"./plus-42YS-w1A.js";import{S as q}from"./save-DJuc85Nt.js";import{M as L}from"./mail-elckFBEn.js";import{R as I}from"./refresh-cw-JBVqlPPd.js";import{M}from"./message-circle-CWw4z9y6.js";import{P as Q}from"./phone-C6GpoGt1.js";import{S as R}from"./WhatsAppButton-CMz-ehNn.js";const P={call:{label:"שיחה",icon:Q,colorClass:"text-blue-600",gradientBg:"bg-gradient-to-br from-blue-100 to-blue-50"},meeting:{label:"פגישה",icon:_,colorClass:"text-purple-600",gradientBg:"bg-gradient-to-br from-purple-100 to-purple-50"},proposal:{label:"הצעת מחיר",icon:E,colorClass:"text-orange-600",gradientBg:"bg-gradient-to-br from-orange-100 to-orange-50"},note:{label:"הערה",icon:M,colorClass:"text-gray-600",gradientBg:"bg-gradient-to-br from-gray-100 to-gray-50"},whatsapp:{label:"WhatsApp",icon:M,colorClass:"text-green-600",gradientBg:"bg-gradient-to-br from-green-100 to-green-50"},status_change:{label:"שינוי סטטוס",icon:I,colorClass:"text-yellow-600",gradientBg:"bg-gradient-to-br from-yellow-100 to-yellow-50"},email:{label:"אימייל",icon:L,colorClass:"text-cyan-600",gradientBg:"bg-gradient-to-br from-cyan-100 to-cyan-50"}},z=Object.entries(P).map(([c,{label:a}])=>({value:c,label:a}));function H(c){const a=new Date(c),i=new Date,r=i.getTime()-a.getTime(),o=Math.floor(r/6e4),d=Math.floor(r/36e5),m=Math.floor(r/864e5),l=a.toLocaleTimeString("he-IL",{hour:"2-digit",minute:"2-digit"}),g=a.getDate()===i.getDate()&&a.getMonth()===i.getMonth()&&a.getFullYear()===i.getFullYear(),n=new Date(i);n.setDate(n.getDate()-1);const b=a.getDate()===n.getDate()&&a.getMonth()===n.getMonth()&&a.getFullYear()===n.getFullYear();return o<1?"עכשיו":o<60?`לפני ${o} דקות`:g?d===1?"לפני שעה":d<4?`לפני ${d} שעות`:`היום ${l}`:b?`אתמול ${l}`:m<7?`לפני ${m} ימים`:a.toLocaleDateString("he-IL",{day:"numeric",month:"short",year:a.getFullYear()!==i.getFullYear()?"numeric":void 0})+` ${l}`}function Z({entityType:c,entityId:a}){const i=T(),[r,o]=v.useState(!1),[d,m]=v.useState("call"),[l,g]=v.useState(""),n=["activities",c,a],{data:b,isLoading:f}=D({queryKey:n,queryFn:()=>(c==="lead"?C.getForLead:C.getForCustomer)(a).then(N=>N.data),enabled:!!a}),x=(b==null?void 0:b.activities)??[],j=B({mutationFn:t=>(c==="lead"?C.addToLead:C.addToCustomer)(a,t),onSuccess:()=>{i.invalidateQueries({queryKey:n}),p.success("הפעולה נוספה בהצלחה"),g(""),m("call"),o(!1)},onError:()=>{p.error("שגיאה בהוספת פעולה")}}),w=t=>{if(t.preventDefault(),!l.trim()){p.error("נא להזין תיאור");return}j.mutate({action:d,description:l.trim()})};return e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"section-header mb-4",children:[e.jsx("div",{className:"section-header-icon bg-gradient-to-br from-primary-100 to-primary-50",children:e.jsx(S,{className:"w-4 h-4 text-primary-600"})}),e.jsx("h2",{className:"section-header-title",children:"יומן פעולות"}),e.jsx("div",{className:"flex-1"}),e.jsx("button",{onClick:()=>o(!r),className:"btn-primary text-sm flex items-center gap-1 px-3 py-1.5",children:r?e.jsx(e.Fragment,{children:"סגור"}):e.jsxs(e.Fragment,{children:[e.jsx(k,{className:"w-4 h-4"}),"הוסף פעולה"]})})]}),r&&e.jsxs("form",{onSubmit:w,className:"mb-6 p-4 bg-gradient-to-br from-primary-50 to-blue-50 rounded-xl border border-primary-100 space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"סוג פעולה"}),e.jsx("select",{value:d,onChange:t=>m(t.target.value),className:"input",children:z.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"תיאור"}),e.jsx("textarea",{value:l,onChange:t=>g(t.target.value),className:"input",rows:3,placeholder:"תאר את הפעולה..."})]}),e.jsxs("button",{type:"submit",disabled:j.isPending||!l.trim(),className:"btn-primary text-sm flex items-center gap-1",children:[e.jsx(q,{className:"w-4 h-4"}),j.isPending?"שומר...":"שמור"]})]}),f&&e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-2 border-primary-600 border-t-transparent"})}),!f&&x.length===0&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"w-14 h-14 rounded-full bg-gradient-to-br from-gray-100 to-gray-50 flex items-center justify-center mx-auto mb-3",children:e.jsx(S,{className:"w-7 h-7 text-gray-300"})}),e.jsx("p",{className:"text-gray-500 font-medium font-heading",children:"אין פעולות עדיין"}),e.jsx("p",{className:"text-gray-400 text-sm mt-1",children:"הוסף פעולה ראשונה כדי להתחיל לעקוב"})]}),!f&&x.length>0&&e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute right-[19px] top-0 bottom-0 w-0.5 bg-gradient-to-b from-primary-200 via-gray-200 to-transparent"}),e.jsx("div",{className:"space-y-0",children:x.map((t,N)=>{const s=P[t.action]??{label:t.action,icon:S,colorClass:"text-gray-600",gradientBg:"bg-gradient-to-br from-gray-100 to-gray-50"},y=s.icon;return e.jsxs("div",{className:"relative flex gap-4 pb-6",children:[e.jsx("div",{className:`relative z-10 flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center shadow-sm border-2 border-white ${s.gradientBg}`,children:e.jsx(y,{className:`w-5 h-5 ${s.colorClass}`})}),e.jsxs("div",{className:"flex-1 pt-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"text-sm font-semibold font-heading text-gray-900",children:s.label}),e.jsx("span",{className:"inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-medium bg-gray-100 text-gray-500",children:H(t.created_at)})]}),t.description&&e.jsx("p",{className:"text-sm text-gray-700 mt-1 whitespace-pre-wrap",children:t.description}),t.user_name&&e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:t.user_name})]}),N===x.length-1&&e.jsx("div",{className:"absolute right-[19px] bottom-0 h-6 w-0.5 bg-white"})]},t.id)})})]})]})}function ee({isOpen:c,onClose:a,defaultTo:i="",defaultName:r=""}){const[o,d]=v.useState(i),[m,l]=v.useState(""),[g,n]=v.useState(""),b=T(),{data:f}=D({queryKey:["email-templates"],queryFn:()=>F.getEmailTemplates().then(s=>s.data),enabled:c}),x=(f==null?void 0:f.templates)??[],j=B({mutationFn:()=>F.sendEmail(o,m,g),onSuccess:()=>{p.success("אימייל נשלח בהצלחה"),b.invalidateQueries({queryKey:["activity-logs"]}),w()},onError:s=>{var u,h;const y=s;p.error(((h=(u=y.response)==null?void 0:u.data)==null?void 0:h.message)||"שגיאה בשליחת אימייל")}}),w=()=>{d(i),l(""),n(""),a()},t=s=>{const y=x.find(Y=>Y.id===s);if(!y)return;let u=y.subject,h=y.body;r&&(u=u.replace(/\{customer_name\}/g,r),h=h.replace(/\{customer_name\}/g,r),u=u.replace(/\{employee_name\}/g,r),h=h.replace(/\{employee_name\}/g,r)),l(u),n(h)},N=()=>{if(!o||!o.includes("@")){p.error("נדרשת כתובת אימייל תקינה");return}if(!m.trim()){p.error("נדרש נושא");return}if(!g.trim()){p.error("נדרש תוכן ההודעה");return}j.mutate()};return c?e.jsx("div",{className:"modal-backdrop",children:e.jsxs("div",{className:"modal-content max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-100",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-lg bg-gradient-to-br from-blue-100 to-blue-50 flex items-center justify-center",children:e.jsx(L,{className:"w-5 h-5 text-blue-600"})}),e.jsx("h2",{className:"text-xl font-bold font-heading",children:"שליחת אימייל"})]}),e.jsx("button",{onClick:w,className:"btn-icon",children:e.jsx(A,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"p-6 space-y-4",children:[x.length>0&&e.jsxs("div",{children:[e.jsxs("label",{className:"label flex items-center gap-2",children:[e.jsx(E,{className:"w-4 h-4"}),"תבנית"]}),e.jsxs("select",{onChange:s=>t(s.target.value),className:"input",defaultValue:"",children:[e.jsx("option",{value:"",children:"בחר תבנית (אופציונלי)..."}),x.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"נמען *"}),e.jsx("input",{type:"email",value:o,onChange:s=>d(s.target.value),className:"input",dir:"ltr",placeholder:"email@example.com"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"נושא *"}),e.jsx("input",{type:"text",value:m,onChange:s=>l(s.target.value),className:"input",placeholder:"נושא האימייל..."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"תוכן ההודעה *"}),e.jsx("textarea",{value:g,onChange:s=>n(s.target.value),className:"input min-h-[200px]",placeholder:"כתוב את ההודעה כאן..."}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"ניתן להשתמש ב-HTML לעיצוב"})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx("button",{onClick:N,disabled:j.isPending,className:"btn-primary flex-1 flex items-center justify-center gap-2",children:j.isPending?e.jsxs(e.Fragment,{children:[e.jsx($,{className:"w-4 h-4 animate-spin"}),"שולח..."]}):e.jsxs(e.Fragment,{children:[e.jsx(R,{className:"w-4 h-4"}),"שלח אימייל"]})}),e.jsx("button",{onClick:w,className:"btn-ghost",children:"ביטול"})]})]})]})}):null}export{Z as A,ee as E};
