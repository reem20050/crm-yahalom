import{x as ge,c as je,m as be,r,e as u,d as k,j as e,S as ve,w as Ne,A as ye,X as re,o as fe,z as m,f as o,h as _e,a2 as we}from"./index-DNhSfFTF.js";import{S as q,c as Ce}from"./Skeleton-B57jvd7z.js";import{P as Se}from"./plus-42YS-w1A.js";import{E as ke}from"./eye-BSeQiPpe.js";import{C as qe}from"./check-circle-rj1BL297.js";/**
 * @license lucide-react v0.302.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fe=ge("MessageSquarePlus",[["path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z",key:"1lielz"}],["path",{d:"M12 7v6",key:"lw1j43"}],["path",{d:"M9 10h6",key:"9gxzsh"}]]),F={theft:"גניבה",break_in:"פריצה",trespassing:"חדירה",vandalism:"ונדליזם",suspicious_activity:"פעילות חשודה",accident:"תאונה",injury:"פגיעה",alarm:"אזעקה",fire:"שריפה",violence:"אלימות",other:"אחר"},j={critical:"קריטי",high:"גבוה",medium:"בינוני",low:"נמוך"},ce={critical:"bg-red-100 text-red-800 border-red-300",high:"bg-orange-100 text-orange-800 border-orange-300",medium:"bg-yellow-100 text-yellow-800 border-yellow-300",low:"bg-green-100 text-green-800 border-green-300"},K={open:"פתוח",investigating:"בחקירה",resolved:"טופל",closed:"סגור"},de={open:"badge-danger",investigating:"badge-warning",resolved:"badge-success",closed:"bg-gray-100 text-gray-700"};function Ee(){var O,L,z,$,R,U,B,D,H,V,X,G,J,W,Y,Z,ee,se,te,ae,le,ie,ne;const d=je(),{can:M}=be(),[b,oe]=r.useState(""),[v,me]=r.useState(""),[N,xe]=r.useState(""),[ue,h]=r.useState(!1),[c,y]=r.useState(null),[x,P]=r.useState(null),[p,T]=r.useState(""),[g,Q]=r.useState(""),[t,l]=r.useState({title:"",incident_type:"suspicious_activity",severity:"medium",customer_id:"",site_id:"",incident_date:new Date().toISOString().split("T")[0],incident_time:new Date().toTimeString().slice(0,5),description:"",location_details:"",police_called:!1,police_report_number:"",ambulance_called:!1,injuries_reported:!1,property_damage:!1,actions_taken:""}),{data:f,isLoading:he}=u({queryKey:["incidents",{search:b,status:v,severity:N}],queryFn:()=>o.getAll({search:b||void 0,status:v||void 0,severity:N||void 0}).then(s=>s.data)}),{data:n}=u({queryKey:["incidents-stats"],queryFn:()=>o.getStats().then(s=>s.data)}),{data:a}=u({queryKey:["incident",c],queryFn:()=>o.getOne(c).then(s=>s.data),enabled:!!c}),{data:_}=u({queryKey:["customers-list"],queryFn:()=>_e.getAll().then(s=>s.data)}),{data:w}=u({queryKey:["sites",t.customer_id],queryFn:()=>we.getByCustomer(t.customer_id).then(s=>s.data),enabled:!!t.customer_id}),C=k({mutationFn:s=>x?o.update(x,s):o.create(s),onSuccess:()=>{d.invalidateQueries({queryKey:["incidents"]}),d.invalidateQueries({queryKey:["incidents-stats"]}),m.success(x?"אירוע עודכן בהצלחה":"אירוע נוצר בהצלחה"),h(!1),P(null),A()},onError:()=>m.error("שגיאה בשמירת אירוע")}),E=k({mutationFn:({id:s,text:i})=>o.addUpdate(s,i),onSuccess:()=>{d.invalidateQueries({queryKey:["incident",c]}),d.invalidateQueries({queryKey:["incidents"]}),m.success("עדכון נוסף בהצלחה"),T("")},onError:()=>m.error("שגיאה בהוספת עדכון")}),S=k({mutationFn:({id:s,resolution:i})=>o.resolve(s,i),onSuccess:()=>{d.invalidateQueries({queryKey:["incident",c]}),d.invalidateQueries({queryKey:["incidents"]}),d.invalidateQueries({queryKey:["incidents-stats"]}),m.success("אירוע נסגר בהצלחה"),Q(""),y(null)},onError:()=>m.error("שגיאה בסגירת אירוע")}),A=()=>{l({title:"",incident_type:"suspicious_activity",severity:"medium",customer_id:"",site_id:"",incident_date:new Date().toISOString().split("T")[0],incident_time:new Date().toTimeString().slice(0,5),description:"",location_details:"",police_called:!1,police_report_number:"",ambulance_called:!1,injuries_reported:!1,property_damage:!1,actions_taken:""})},pe=s=>{s.preventDefault(),C.mutate(t)},I=(f==null?void 0:f.incidents)||[];return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"page-header",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"page-title flex items-center gap-2",children:[e.jsx(ve,{className:"w-7 h-7 text-danger-500"}),"אירועי אבטחה"]}),e.jsx("p",{className:"page-subtitle",children:"ניהול ותיעוד אירועי אבטחה"})]}),M("incidents:create")&&e.jsxs("button",{onClick:()=>{A(),P(null),h(!0)},className:"btn-primary flex items-center gap-2",children:[e.jsx(Se,{className:"w-4 h-4"}),"דיווח חדש"]})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"card !p-4 text-center",children:[e.jsx("p",{className:"text-2xl font-bold font-heading text-danger-600",children:(n==null?void 0:n.open_count)||0}),e.jsx("p",{className:"text-sm text-gray-500",children:"פתוחים"})]}),e.jsxs("div",{className:"card !p-4 text-center",children:[e.jsx("p",{className:"text-2xl font-bold font-heading text-warning-600",children:(n==null?void 0:n.investigating_count)||0}),e.jsx("p",{className:"text-sm text-gray-500",children:"בחקירה"})]}),e.jsxs("div",{className:"card !p-4 text-center",children:[e.jsx("p",{className:"text-2xl font-bold font-heading text-success-600",children:(n==null?void 0:n.resolved_this_month)||0}),e.jsx("p",{className:"text-sm text-gray-500",children:"טופלו החודש"})]}),e.jsxs("div",{className:"card !p-4 text-center",children:[e.jsx("p",{className:"text-2xl font-bold font-heading text-danger-800",children:(n==null?void 0:n.critical_open)||0}),e.jsx("p",{className:"text-sm text-gray-500",children:"קריטיים"})]})]}),e.jsx("div",{className:"card !p-4",children:e.jsxs("div",{className:"flex flex-wrap gap-4",children:[e.jsxs("div",{className:"flex-1 min-w-[200px] relative",children:[e.jsx(Ne,{className:"absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400 pointer-events-none"}),e.jsx("input",{type:"text",placeholder:"חיפוש אירועים...",value:b,onChange:s=>oe(s.target.value),className:"input pr-11 w-full"})]}),e.jsxs("select",{value:v,onChange:s=>me(s.target.value),className:"input",children:[e.jsx("option",{value:"",children:"כל הסטטוסים"}),Object.entries(K).map(([s,i])=>e.jsx("option",{value:s,children:i},s))]}),e.jsxs("select",{value:N,onChange:s=>xe(s.target.value),className:"input",children:[e.jsx("option",{value:"",children:"כל החומרות"}),Object.entries(j).map(([s,i])=>e.jsx("option",{value:s,children:i},s))]})]})}),he?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{className:"h-8 w-40"}),e.jsx(q,{className:"h-4 w-56"})]}),e.jsx(q,{className:"h-10 w-36 rounded-xl"})]}),e.jsx(Ce,{columns:5,rows:5})]}):I.length===0?e.jsxs("div",{className:"empty-state",children:[e.jsx("div",{className:"empty-state-icon",children:e.jsx(ye,{className:"w-8 h-8 text-gray-400"})}),e.jsx("h3",{className:"empty-state-title",children:"לא נמצאו אירועי אבטחה"}),e.jsx("p",{className:"text-sm text-gray-500",children:"אין אירועים התואמים לסינון הנוכחי"})]}):e.jsx("div",{className:"table-container",children:e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"חומרה"}),e.jsx("th",{children:"כותרת"}),e.jsx("th",{children:"סוג"}),e.jsx("th",{children:"אתר / לקוח"}),e.jsx("th",{children:"תאריך"}),e.jsx("th",{children:"סטטוס"}),e.jsx("th",{children:"פעולות"})]})}),e.jsx("tbody",{children:I.map(s=>{const i=s.severity==="critical"?"bg-danger-50 ring-1 ring-danger-200 border-r-4 border-r-danger-500":s.severity==="high"?"bg-accent-50 border-r-4 border-r-accent-500":s.severity==="medium"?"bg-warning-50 border-r-4 border-r-warning-500":"bg-success-50 border-r-4 border-r-success-500";return e.jsxs("tr",{className:`border-b border-gray-50 last:border-0 hover:shadow-sm transition-shadow ${i}`,children:[e.jsx("td",{children:e.jsx("span",{className:`inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full text-xs font-bold border ${ce[s.severity]||""}`,children:j[s.severity]||s.severity})}),e.jsx("td",{className:"font-medium text-gray-900",children:s.title}),e.jsx("td",{className:"text-sm text-gray-600",children:F[s.incident_type]||s.incident_type}),e.jsx("td",{className:"text-sm text-gray-600",children:s.site_name||s.company_name||"-"}),e.jsxs("td",{className:"text-sm text-gray-600",children:[s.incident_date," ",s.incident_time]}),e.jsx("td",{children:e.jsx("span",{className:`badge ${de[s.status]||""}`,children:K[s.status]||s.status})}),e.jsx("td",{children:e.jsx("div",{className:"flex gap-1",children:e.jsx("button",{onClick:()=>y(s.id),className:"p-1.5 rounded-lg hover:bg-white/60 transition-colors",title:"צפה",children:e.jsx(ke,{className:"w-4 h-4 text-gray-500"})})})})]},s.id)})})]})}),ue&&e.jsx("div",{className:"modal-backdrop",children:e.jsxs("div",{className:"modal-content w-full max-w-2xl",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b",children:[e.jsx("h2",{className:"text-lg font-bold font-heading",children:x?"עריכת אירוע":"דיווח אירוע אבטחה"}),e.jsx("button",{onClick:()=>h(!1),className:"p-2 hover:bg-gray-100 rounded-lg",children:e.jsx(re,{className:"w-5 h-5"})})]}),e.jsxs("form",{onSubmit:pe,className:"p-6 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"label",children:"כותרת *"}),e.jsx("input",{type:"text",required:!0,value:t.title,onChange:s=>l({...t,title:s.target.value}),className:"input w-full",placeholder:"תיאור קצר של האירוע"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"סוג אירוע *"}),e.jsx("select",{value:t.incident_type,onChange:s=>l({...t,incident_type:s.target.value}),className:"input w-full",children:Object.entries(F).map(([s,i])=>e.jsx("option",{value:s,children:i},s))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"חומרה *"}),e.jsx("select",{value:t.severity,onChange:s=>l({...t,severity:s.target.value}),className:"input w-full",children:Object.entries(j).map(([s,i])=>e.jsx("option",{value:s,children:i},s))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"לקוח"}),e.jsxs("select",{value:t.customer_id,onChange:s=>l({...t,customer_id:s.target.value,site_id:""}),className:"input w-full",children:[e.jsx("option",{value:"",children:"בחר לקוח"}),((_==null?void 0:_.customers)||[]).map(s=>e.jsx("option",{value:s.id,children:s.company_name},s.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"אתר"}),e.jsxs("select",{value:t.site_id,onChange:s=>l({...t,site_id:s.target.value}),className:"input w-full",disabled:!t.customer_id,children:[e.jsx("option",{value:"",children:"בחר אתר"}),((w==null?void 0:w.sites)||[]).map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"תאריך *"}),e.jsx("input",{type:"date",required:!0,value:t.incident_date,onChange:s=>l({...t,incident_date:s.target.value}),className:"input w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"שעה *"}),e.jsx("input",{type:"time",required:!0,value:t.incident_time,onChange:s=>l({...t,incident_time:s.target.value}),className:"input w-full"})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"label",children:"תיאור מפורט *"}),e.jsx("textarea",{required:!0,rows:3,value:t.description,onChange:s=>l({...t,description:s.target.value}),className:"input w-full",placeholder:"תאר את האירוע בפירוט..."})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"label",children:"מיקום מדויק באתר"}),e.jsx("input",{type:"text",value:t.location_details,onChange:s=>l({...t,location_details:s.target.value}),className:"input w-full",placeholder:"למשל: שער כניסה ראשי, חניון B"})]}),e.jsxs("div",{className:"md:col-span-2 grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:t.police_called,onChange:s=>l({...t,police_called:s.target.checked}),className:"rounded"}),e.jsx("span",{className:"text-sm",children:"הוזעקה משטרה"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:t.ambulance_called,onChange:s=>l({...t,ambulance_called:s.target.checked}),className:"rounded"}),e.jsx("span",{className:"text-sm",children:"הוזעק אמבולנס"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:t.injuries_reported,onChange:s=>l({...t,injuries_reported:s.target.checked}),className:"rounded"}),e.jsx("span",{className:"text-sm",children:"דווח על נפגעים"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:t.property_damage,onChange:s=>l({...t,property_damage:s.target.checked}),className:"rounded"}),e.jsx("span",{className:"text-sm",children:"נזק לרכוש"})]})]}),t.police_called&&e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"label",children:"מספר תיק משטרה"}),e.jsx("input",{type:"text",value:t.police_report_number,onChange:s=>l({...t,police_report_number:s.target.value}),className:"input w-full"})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"label",children:"פעולות שננקטו"}),e.jsx("textarea",{rows:2,value:t.actions_taken,onChange:s=>l({...t,actions_taken:s.target.value}),className:"input w-full",placeholder:"מה נעשה במקום?"})]})]}),e.jsxs("div",{className:"flex gap-3 pt-4 border-t",children:[e.jsx("button",{type:"submit",className:"btn-primary",disabled:C.isPending,children:C.isPending?"שומר...":x?"עדכן":"דווח אירוע"}),e.jsx("button",{type:"button",onClick:()=>h(!1),className:"btn-secondary",children:"ביטול"})]})]})]})}),c&&a&&e.jsx("div",{className:"modal-backdrop",children:e.jsxs("div",{className:"modal-content w-full max-w-3xl",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:`px-2.5 py-1 rounded-full text-xs font-bold border ${ce[(O=a.incident)==null?void 0:O.severity]||""}`,children:j[(L=a.incident)==null?void 0:L.severity]}),e.jsx("h2",{className:"text-lg font-bold font-heading",children:(z=a.incident)==null?void 0:z.title})]}),e.jsx("button",{onClick:()=>y(null),className:"p-2 hover:bg-gray-100 rounded-lg",children:e.jsx(re,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"סוג"}),e.jsx("p",{className:"font-medium",children:F[($=a.incident)==null?void 0:$.incident_type]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"תאריך ושעה"}),e.jsxs("p",{className:"font-medium",children:[(R=a.incident)==null?void 0:R.incident_date," ",(U=a.incident)==null?void 0:U.incident_time]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"סטטוס"}),e.jsx("span",{className:`badge ${de[(B=a.incident)==null?void 0:B.status]}`,children:K[(D=a.incident)==null?void 0:D.status]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"אתר"}),e.jsx("p",{className:"font-medium",children:((H=a.incident)==null?void 0:H.site_name)||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"לקוח"}),e.jsx("p",{className:"font-medium",children:((V=a.incident)==null?void 0:V.company_name)||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"מדווח"}),e.jsx("p",{className:"font-medium",children:((X=a.incident)==null?void 0:X.reporter_name)||"-"})]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:"תיאור"}),e.jsx("p",{className:"bg-gray-50 p-3 rounded-lg",children:(G=a.incident)==null?void 0:G.description})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[(J=a.incident)!=null&&J.police_called?e.jsx("span",{className:"badge bg-blue-100 text-blue-800",children:"משטרה הוזעקה"}):null,(W=a.incident)!=null&&W.ambulance_called?e.jsx("span",{className:"badge bg-red-100 text-red-800",children:"אמבולנס הוזעק"}):null,(Y=a.incident)!=null&&Y.injuries_reported?e.jsx("span",{className:"badge bg-red-100 text-red-800",children:"נפגעים"}):null,(Z=a.incident)!=null&&Z.property_damage?e.jsx("span",{className:"badge bg-orange-100 text-orange-800",children:"נזק לרכוש"}):null]}),((ee=a.incident)==null?void 0:ee.actions_taken)&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:"פעולות שננקטו"}),e.jsx("p",{className:"bg-green-50 p-3 rounded-lg",children:a.incident.actions_taken})]}),e.jsxs("div",{children:[e.jsxs("h3",{className:"font-semibold text-gray-900 mb-3 flex items-center gap-2",children:[e.jsx(fe,{className:"w-4 h-4"}),"עדכונים (",((se=a.updates)==null?void 0:se.length)||0,")"]}),((te=a.updates)==null?void 0:te.length)>0?e.jsx("div",{className:"space-y-3 border-r-2 border-gray-200 pr-4 mr-2",children:a.updates.map(s=>e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute -right-[21px] top-1 w-3 h-3 rounded-full bg-primary-500 border-2 border-white"}),e.jsx("p",{className:"text-sm",children:s.update_text}),e.jsxs("p",{className:"text-xs text-gray-400 mt-1",children:[s.user_name," | ",new Date(s.created_at).toLocaleString("he-IL")]})]},s.id))}):e.jsx("p",{className:"text-sm text-gray-400",children:"אין עדכונים עדיין"}),((ae=a.incident)==null?void 0:ae.status)!=="closed"&&e.jsxs("div",{className:"mt-4 flex gap-2",children:[e.jsx("input",{type:"text",placeholder:"הוסף עדכון...",value:p,onChange:s=>T(s.target.value),className:"input flex-1"}),e.jsxs("button",{onClick:()=>{p.trim()&&E.mutate({id:c,text:p})},disabled:!p.trim()||E.isPending,className:"btn-primary flex items-center gap-1",children:[e.jsx(Fe,{className:"w-4 h-4"}),"עדכן"]})]})]}),M("incidents:resolve")&&((le=a.incident)==null?void 0:le.status)!=="resolved"&&((ie=a.incident)==null?void 0:ie.status)!=="closed"&&e.jsxs("div",{className:"border-t pt-4",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 mb-3 flex items-center gap-2",children:[e.jsx(qe,{className:"w-4 h-4 text-green-500"}),"סגירת אירוע"]}),e.jsx("textarea",{rows:2,placeholder:"תיאור הפתרון / סיכום...",value:g,onChange:s=>Q(s.target.value),className:"input w-full mb-3"}),e.jsx("button",{onClick:()=>{g.trim()&&S.mutate({id:c,resolution:g})},disabled:!g.trim()||S.isPending,className:"btn-success",children:S.isPending?"סוגר...":"סגור אירוע"})]}),((ne=a.incident)==null?void 0:ne.resolution)&&e.jsxs("div",{className:"bg-green-50 border border-green-200 p-4 rounded-lg",children:[e.jsx("p",{className:"text-sm text-green-700 font-medium mb-1",children:"פתרון:"}),e.jsx("p",{children:a.incident.resolution}),a.incident.resolution_date&&e.jsxs("p",{className:"text-xs text-green-600 mt-2",children:["נסגר: ",a.incident.resolution_date]})]})]})]})})]})}export{Ee as default};
