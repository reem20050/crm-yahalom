import{t as Q,c as O,r as c,e as K,d as y,j as e,S as V,X as L,L as W,z as x,ab as o}from"./index-CYVBYVvl.js";import{S as F,c as Y}from"./Skeleton-DLC-Bf1b.js";import{P as Z}from"./plus-p_an0ThM.js";import{U as A}from"./unlink-B-MvbgMh.js";import{P as ee}from"./pencil-DUIHc07a.js";import{K as se}from"./key-round-ByJDGwCJ.js";/**
 * @license lucide-react v0.302.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const h=Q("Link2",[["path",{d:"M9 17H7A5 5 0 0 1 7 7h2",key:"8i5ue5"}],["path",{d:"M15 7h2a5 5 0 1 1 0 10h-2",key:"1b9ql8"}],["line",{x1:"8",x2:"16",y1:"12",y2:"12",key:"1jonct"}]]);/**
 * @license lucide-react v0.302.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ae=Q("UserCheck",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["polyline",{points:"16 11 18 13 22 9",key:"1pwet4"}]]);/**
 * @license lucide-react v0.302.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const te=Q("UserX",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"17",x2:"22",y1:"8",y2:"13",key:"3nzzx3"}],["line",{x1:"22",x2:"17",y1:"8",y2:"13",key:"1swrse"}]]),I={email:"",password:"",first_name:"",last_name:"",phone:"",role:"employee",employee_id:""},le={admin:"מנהל",manager:"מנהל משמרות",employee:"עובד"},ne={admin:"bg-purple-100 text-purple-800",manager:"bg-blue-100 text-blue-800",employee:"bg-gray-100 text-gray-800"};function xe(){const i=O(),[$,v]=c.useState(!1),[p,w]=c.useState(null),[t,r]=c.useState(I),[_,g]=c.useState(null),[k,C]=c.useState(""),[j,n]=c.useState(""),[d,b]=c.useState(null),[N,u]=c.useState(""),{data:U=[],isLoading:D}=K({queryKey:["users"],queryFn:async()=>(await o.getAll()).data}),{data:S=[]}=K({queryKey:["unlinked-employees"],queryFn:async()=>(await o.getUnlinkedEmployees()).data}),{data:R=[]}=K({queryKey:["all-employees"],queryFn:async()=>(await o.getAllEmployees()).data}),q=y({mutationFn:s=>o.create(s),onSuccess:()=>{i.invalidateQueries({queryKey:["users"]}),i.invalidateQueries({queryKey:["unlinked-employees"]}),i.invalidateQueries({queryKey:["all-employees"]}),x.success("משתמש נוצר בהצלחה"),f()},onError:s=>{var a,l;n(((l=(a=s.response)==null?void 0:a.data)==null?void 0:l.error)||"שגיאה ביצירת משתמש")}}),E=y({mutationFn:({id:s,data:a})=>o.update(s,a),onSuccess:()=>{i.invalidateQueries({queryKey:["users"]}),x.success("משתמש עודכן בהצלחה"),f()},onError:s=>{var a,l;n(((l=(a=s.response)==null?void 0:a.data)==null?void 0:l.error)||"שגיאה בעדכון משתמש")}}),z=y({mutationFn:({id:s,is_active:a})=>o.update(s,{is_active:a}),onSuccess:()=>{i.invalidateQueries({queryKey:["users"]}),x.success("סטטוס משתמש עודכן")},onError:()=>x.error("שגיאה בעדכון סטטוס משתמש")}),P=y({mutationFn:({id:s,password:a})=>o.resetPassword(s,a),onSuccess:()=>{x.success("סיסמה אופסה בהצלחה"),g(null),C("")},onError:s=>{var a,l;n(((l=(a=s.response)==null?void 0:a.data)==null?void 0:l.error)||"שגיאה באיפוס סיסמה")}}),M=y({mutationFn:({userId:s,employeeId:a})=>o.linkEmployee(s,a),onSuccess:(s,a)=>{i.invalidateQueries({queryKey:["users"]}),i.invalidateQueries({queryKey:["unlinked-employees"]}),i.invalidateQueries({queryKey:["all-employees"]}),x.success(a.employeeId?"העובד שויך בהצלחה":"שיוך העובד הוסר"),b(null),u("")},onError:s=>{var a,l;x.error(((l=(a=s.response)==null?void 0:a.data)==null?void 0:l.error)||"שגיאה בשיוך עובד")}}),f=()=>{v(!1),w(null),r(I),n("")},H=()=>{r(I),w(null),n(""),v(!0)},X=s=>{w(s),r({email:s.email,password:"",first_name:s.first_name,last_name:s.last_name,phone:s.phone||"",role:s.role,employee_id:""}),n(""),v(!0)},G=s=>{b(s),u(s.employee_id||"")},B=s=>{if(s.preventDefault(),n(""),p){const a={first_name:t.first_name,last_name:t.last_name,phone:t.phone,role:t.role,email:t.email};E.mutate({id:p.id,data:a})}else{if(!t.password){n("נא להזין סיסמה");return}const a={...t};t.employee_id||delete a.employee_id,q.mutate(a)}},T=s=>s?new Date(s).toLocaleDateString("he-IL",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"-",J=s=>R.filter(a=>!a.user_id||a.user_id===s);return D?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{className:"h-8 w-40"}),e.jsx(F,{className:"h-4 w-64"})]}),e.jsx(F,{className:"h-10 w-32 rounded-xl"})]}),e.jsx(Y,{columns:7,rows:4})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"ניהול משתמשים"}),e.jsx("p",{className:"text-gray-500 mt-1",children:"ניהול חשבונות משתמשים, הרשאות גישה ושיוך לעובדים"})]}),e.jsxs("button",{onClick:H,className:"btn-primary flex items-center gap-2",children:[e.jsx(Z,{className:"h-5 w-5"}),"הוסף משתמש"]})]}),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4 flex items-start gap-3",children:[e.jsx(V,{className:"h-5 w-5 text-blue-600 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"text-sm text-blue-800",children:[e.jsx("strong",{children:"שיוך עובד:"}),` כל משתמש מסוג "עובד" חייב להיות משויך לרשומת עובד כדי שיוכל לבצע צ'ק-אין, לראות משמרות ולהירשם למשמרות פתוחות. לחץ על כפתור השיוך (`,e.jsx(h,{className:"w-3.5 h-3.5 inline"}),") כדי לשייך או לנתק עובד."]})]}),e.jsx("div",{className:"card overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"שם"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"אימייל"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"תפקיד"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"עובד משויך"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"סטטוס"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"התחברות אחרונה"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"פעולות"})]})}),e.jsxs("tbody",{className:"bg-white divide-y divide-gray-200",children:[U.map(s=>{var a,l;return e.jsxs("tr",{className:s.is_active?"":"bg-gray-50 opacity-60",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"h-8 w-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-700 font-medium text-sm",children:[(a=s.first_name)==null?void 0:a[0],(l=s.last_name)==null?void 0:l[0]]}),e.jsxs("span",{className:"font-medium text-gray-900",children:[s.first_name," ",s.last_name]})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-600 direction-ltr text-right",children:s.email}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:`inline-flex px-2.5 py-0.5 rounded-full text-xs font-medium ${ne[s.role]||"bg-gray-100 text-gray-800"}`,children:le[s.role]||s.role})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:s.employee_id?e.jsxs("span",{className:"inline-flex items-center gap-1.5 px-2.5 py-1 rounded-lg bg-green-50 text-green-700 text-sm font-medium",children:[e.jsx(h,{className:"w-3.5 h-3.5"}),s.employee_first_name," ",s.employee_last_name]}):e.jsxs("span",{className:"inline-flex items-center gap-1.5 px-2.5 py-1 rounded-lg bg-amber-50 text-amber-600 text-sm",children:[e.jsx(A,{className:"w-3.5 h-3.5"}),"לא משויך"]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:s.is_active?e.jsx("span",{className:"badge-success",children:"פעיל"}):e.jsx("span",{className:"badge-danger",children:"מושבת"})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:T(s.last_login)}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:()=>G(s),className:`p-1.5 rounded ${s.employee_id?"text-green-600 hover:text-green-700 hover:bg-green-50":"text-amber-500 hover:text-amber-600 hover:bg-amber-50"}`,title:s.employee_id?"שנה שיוך עובד":"שייך עובד",children:e.jsx(h,{className:"h-4 w-4"})}),e.jsx("button",{onClick:()=>X(s),className:"p-1.5 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded",title:"ערוך",children:e.jsx(ee,{className:"h-4 w-4"})}),e.jsx("button",{onClick:()=>{g({userId:s.id,userName:`${s.first_name} ${s.last_name}`}),C(""),n("")},className:"p-1.5 text-gray-400 hover:text-orange-600 hover:bg-orange-50 rounded",title:"איפוס סיסמה",children:e.jsx(se,{className:"h-4 w-4"})}),s.is_active?e.jsx("button",{onClick:()=>z.mutate({id:s.id,is_active:0}),className:"p-1.5 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded",title:"השבת משתמש",children:e.jsx(te,{className:"h-4 w-4"})}):e.jsx("button",{onClick:()=>z.mutate({id:s.id,is_active:1}),className:"p-1.5 text-gray-400 hover:text-green-600 hover:bg-green-50 rounded",title:"הפעל משתמש",children:e.jsx(ae,{className:"h-4 w-4"})})]})})]},s.id)}),U.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"px-6 py-12 text-center text-gray-500",children:"אין משתמשים במערכת"})})]})]})})}),$&&e.jsx("div",{className:"fixed inset-0 bg-gray-900/40 backdrop-blur-sm animate-fade-in flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl max-w-lg w-full",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b",children:[e.jsx("h2",{className:"text-lg font-bold",children:p?"עריכת משתמש":"הוספת משתמש חדש"}),e.jsx("button",{onClick:f,className:"text-gray-400 hover:text-gray-600",children:e.jsx(L,{className:"h-5 w-5"})})]}),e.jsxs("form",{onSubmit:B,className:"p-6 space-y-4",children:[j&&e.jsx("div",{className:"bg-red-50 text-red-700 p-3 rounded-lg text-sm",children:j}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"שם פרטי *"}),e.jsx("input",{type:"text",className:"input",value:t.first_name,onChange:s=>r({...t,first_name:s.target.value}),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"שם משפחה *"}),e.jsx("input",{type:"text",className:"input",value:t.last_name,onChange:s=>r({...t,last_name:s.target.value}),required:!0})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"אימייל *"}),e.jsx("input",{type:"email",className:"input",dir:"ltr",value:t.email,onChange:s=>r({...t,email:s.target.value}),required:!0}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"אם הכתובת היא Gmail, המשתמש יוכל גם להתחבר עם Google"})]}),!p&&e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"סיסמה *"}),e.jsx("input",{type:"password",className:"input",dir:"ltr",value:t.password,onChange:s=>r({...t,password:s.target.value}),minLength:6,placeholder:"לפחות 6 תווים",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"טלפון"}),e.jsx("input",{type:"tel",className:"input",dir:"ltr",value:t.phone,onChange:s=>r({...t,phone:s.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"תפקיד *"}),e.jsxs("select",{className:"input",value:t.role,onChange:s=>r({...t,role:s.target.value}),children:[e.jsx("option",{value:"employee",children:"עובד"}),e.jsx("option",{value:"manager",children:"מנהל משמרות"}),e.jsx("option",{value:"admin",children:"מנהל"})]})]}),!p&&S.length>0&&e.jsxs("div",{className:"border-t pt-4",children:[e.jsxs("label",{className:"label flex items-center gap-1.5",children:[e.jsx(h,{className:"w-3.5 h-3.5"}),"שייך לעובד קיים"]}),e.jsxs("select",{className:"input",value:t.employee_id,onChange:s=>{const a=s.target.value;if(r({...t,employee_id:a}),a){const l=S.find(m=>m.id===a);l&&r(m=>({...m,employee_id:a,first_name:m.first_name||l.first_name,last_name:m.last_name||l.last_name,phone:m.phone||l.phone||"",email:m.email||l.email||""}))}},children:[e.jsx("option",{value:"",children:"-- ללא שיוך --"}),S.map(s=>e.jsxs("option",{value:s.id,children:[s.first_name," ",s.last_name," ",s.phone?`(${s.phone})`:""]},s.id))]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"שיוך למשתמש מאפשר לעובד להתחבר ולבצע צ'ק-אין"})]}),e.jsxs("div",{className:"flex gap-3 pt-4 border-t",children:[e.jsx("button",{type:"submit",className:"btn-primary flex-1",disabled:q.isPending||E.isPending,children:q.isPending||E.isPending?"שומר...":p?"עדכן":"צור משתמש"}),e.jsx("button",{type:"button",onClick:f,className:"btn-secondary",children:"ביטול"})]})]})]})}),d&&e.jsx("div",{className:"fixed inset-0 bg-gray-900/40 backdrop-blur-sm animate-fade-in flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl max-w-md w-full",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b",children:[e.jsxs("h2",{className:"text-lg font-bold flex items-center gap-2",children:[e.jsx(h,{className:"w-5 h-5 text-primary-600"}),"שיוך עובד למשתמש"]}),e.jsx("button",{onClick:()=>{b(null),u("")},className:"text-gray-400 hover:text-gray-600",children:e.jsx(L,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"bg-gray-50 rounded-lg p-3",children:[e.jsx("p",{className:"text-sm text-gray-500",children:"משתמש:"}),e.jsxs("p",{className:"font-semibold text-gray-900",children:[d.first_name," ",d.last_name]}),e.jsx("p",{className:"text-sm text-gray-500 direction-ltr text-right",children:d.email})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"בחר עובד לשיוך"}),e.jsxs("select",{className:"input",value:N,onChange:s=>u(s.target.value),children:[e.jsx("option",{value:"",children:"-- ללא שיוך (נתק) --"}),J(d.id).map(s=>e.jsxs("option",{value:s.id,children:[s.first_name," ",s.last_name,s.phone?` (${s.phone})`:"",s.user_id===d.id?" ✓ משויך כרגע":""]},s.id))]})]}),d.employee_id&&!N&&e.jsx("div",{className:"bg-amber-50 border border-amber-200 text-amber-800 px-3 py-2 rounded-lg text-sm",children:"שים לב: ניתוק העובד מהמשתמש ימנע ממנו גישה לפאנל שומר, צ'ק-אין ומשמרות פתוחות."}),e.jsxs("div",{className:"flex gap-3 pt-4 border-t",children:[e.jsx("button",{onClick:()=>{M.mutate({userId:d.id,employeeId:N||null})},className:"btn-primary flex-1 flex items-center justify-center gap-2",disabled:M.isPending,children:M.isPending?e.jsx(W,{className:"w-4 h-4 animate-spin"}):N?e.jsxs(e.Fragment,{children:[e.jsx(h,{className:"w-4 h-4"}),"שייך עובד"]}):e.jsxs(e.Fragment,{children:[e.jsx(A,{className:"w-4 h-4"}),"נתק שיוך"]})}),e.jsx("button",{onClick:()=>{b(null),u("")},className:"btn-secondary",children:"ביטול"})]})]})]})}),_&&e.jsx("div",{className:"fixed inset-0 bg-gray-900/40 backdrop-blur-sm animate-fade-in flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl max-w-md w-full",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b",children:[e.jsx("h2",{className:"text-lg font-bold",children:"איפוס סיסמה"}),e.jsx("button",{onClick:()=>{g(null),n("")},className:"text-gray-400 hover:text-gray-600",children:e.jsx(L,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"p-6 space-y-4",children:[j&&e.jsx("div",{className:"bg-red-50 text-red-700 p-3 rounded-lg text-sm",children:j}),e.jsxs("p",{className:"text-gray-600",children:["איפוס סיסמה עבור ",e.jsx("strong",{children:_.userName})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"סיסמה חדשה"}),e.jsx("input",{type:"password",className:"input",dir:"ltr",value:k,onChange:s=>C(s.target.value),minLength:6,placeholder:"לפחות 6 תווים"})]}),e.jsxs("div",{className:"flex gap-3 pt-4 border-t",children:[e.jsx("button",{onClick:()=>{if(k.length<6){n("הסיסמה חייבת להכיל לפחות 6 תווים");return}n(""),P.mutate({id:_.userId,password:k})},className:"btn-primary flex-1",disabled:P.isPending,children:P.isPending?"מאפס...":"אפס סיסמה"}),e.jsx("button",{onClick:()=>{g(null),n("")},className:"btn-secondary",children:"ביטול"})]})]})]})})]})}export{xe as default};
